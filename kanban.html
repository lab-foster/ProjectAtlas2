<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Project Atlas ‚Äì Kanban board with dependencies, drag & drop, and task detail sheet."/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Kanban Board - Project Atlas</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üóÇÔ∏è</text></svg>"/>

  <!-- Styles -->
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>
</head>
<body class="app-page">
  <a href="#main" class="skip-to-main">Skip to main content</a>

  <!-- Header -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>

      <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="mainNav"
              onclick="toggleMobileMenu()"><span aria-hidden="true">‚ò∞</span></button>

      <nav id="mainNav" class="main-nav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="kanban.html" class="active" aria-current="page">Kanban Board</a></li>
          <li><a href="budget.html">Budget Tracker</a></li>
          <li><a href="calendar.html">Calendar</a></li>
          <li><a href="documents.html">Documents</a></li>
        </ul>
      </nav>

      <div class="user-menu">
        <button class="btn btn-secondary" onclick="openCreateTask()" aria-label="Add task">+ Task</button>
        <button class="btn btn-secondary" onclick="openColumnsDialog()" aria-label="Choose columns">Columns</button>
        <button class="user-avatar" title="User Menu">AF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main id="main" class="dashboard-container" style="padding-top:1rem;">
    <section class="dashboard-header" style="margin-bottom: .75rem;">
      <h2 id="boardTitle">Kanban Board</h2>
      <p id="boardSubtitle" class="text-tertiary">Drag cards between columns. Click a card to view details.</p>
      <div class="form-row" style="margin-top:.5rem;">
        <div>
          <label for="searchTasks">Search</label>
          <input id="searchTasks" class="input" placeholder="Search by title, description, or tags‚Ä¶" oninput="applyFilters()"/>
        </div>
        <div>
          <label for="assigneeFilter">Assignee</label>
          <select id="assigneeFilter" class="input" onchange="applyFilters()">
            <option value="">All</option>
            <option value="Andrew">Andrew</option>
            <option value="Katie">Katie</option>
            <option value="Contractor">Contractor</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Board -->
    <section id="kanban" class="kanban" aria-label="Kanban board">
      <!-- Columns injected by JS -->
    </section>
  </main>

  <!-- Task Drawer (fallback if window.atlas not present) -->
  <aside id="taskSheet" class="task-sheet" aria-label="Task details panel">
    <header>
      <strong id="sheetTitle">Task</strong>
      <button class="modal-close" aria-label="Close" onclick="closeTaskSheet()">&times;</button>
    </header>
    <div class="sheet-body">
      <div id="sheetContent"></div>
    </div>
  </aside>

  <!-- Generic modal/backdrop for create task & columns config -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modalRoot" class="modal" aria-hidden="true"></div>

  <!-- Scripts -->
  <script>
    // ---------- Mobile Nav ----------
    function toggleMobileMenu(){
      const nav = document.getElementById('mainNav');
      const btn = document.querySelector('.mobile-menu-toggle');
      const on = nav.classList.toggle('active');
      btn.setAttribute('aria-expanded', on);
    }
    document.addEventListener('click',(e)=>{
      const nav = document.getElementById('mainNav');
      const btn = document.querySelector('.mobile-menu-toggle');
      if(nav.classList.contains('active') && !nav.contains(e.target) && !btn.contains(e.target)){
        toggleMobileMenu();
      }
    });

    // ---------- Data Model ----------
    const STATUSES = ["Someday","Planning","Ready","In Progress","Blocked","Done"];
    const DEFAULT_VISIBLE = ["Someday","Planning","Ready","In Progress","Blocked","Done"];

    // Seed data (only used first load)
    const seedTasks = [
      {id:"t1", title:"Research countertop materials", desc:"Quartz vs granite. Look at Costco & local fabricators.", status:"Someday", project:"kitchen", assignee:"Andrew", priority:"Low", due:"", deps:[]},
      {id:"t2", title:"Submit basement permit", desc:"City of Woodinville online portal", status:"Planning", project:"basement", assignee:"Andrew", priority:"High", due:"2025-10-18", deps:[]},
      {id:"t3", title:"Order bathroom vanity", desc:"36‚Äù oak, matte black hardware ‚Äì Home Depot", status:"Ready", project:"bathroom", assignee:"Katie", priority:"Medium", due:"2025-10-15", deps:[]},
      {id:"t4", title:"Install backsplash", desc:"Subway tile herringbone. Use leveling clips.", status:"In Progress", project:"kitchen", assignee:"Contractor", priority:"High", due:"2025-10-20", deps:["t6"]},
      {id:"t5", title:"Seal grout", desc:"After 72 hours, apply two coats.", status:"Blocked", project:"kitchen", assignee:"Andrew", priority:"Low", due:"", deps:["t4"]},
      {id:"t6", title:"Countertop template", desc:"Schedule template after cabinet alignment.", status:"Done", project:"kitchen", assignee:"Contractor", priority:"High", due:"2025-10-10", deps:[]},
    ];

    const storage = {
      keyBoard: "atlas.kanban.tasks",
      keyColumns: "atlas.kanban.visibleColumns",
      getTasks(){ try{ return JSON.parse(localStorage.getItem(this.keyBoard)) || seedTasks; }catch{ return seedTasks; } },
      saveTasks(tasks){ localStorage.setItem(this.keyBoard, JSON.stringify(tasks)); },
      getVisible(){ try{ return JSON.parse(localStorage.getItem(this.keyColumns)) || DEFAULT_VISIBLE; }catch{ return DEFAULT_VISIBLE; } },
      saveVisible(cols){ localStorage.setItem(this.keyColumns, JSON.stringify(cols)); }
    };

    let tasks = storage.getTasks();
    let visibleColumns = storage.getVisible();
    let filterText = "";
    let filterAssignee = "";

    // If arriving with ?project= in URL, set title
    const params = new URLSearchParams(location.search);
    const projectParam = params.get("project");
    if(projectParam){
      const pretty = projectParam.charAt(0).toUpperCase()+projectParam.slice(1);
      document.getElementById("boardTitle").textContent = `${pretty} ‚Äì Kanban Board`;
    }

    // ---------- Rendering ----------
    const $board = document.getElementById("kanban");

    function renderBoard(){
      $board.innerHTML = "";
      const filtered = tasks.filter(t => {
        const matchesText = !filterText || (t.title + " " + t.desc).toLowerCase().includes(filterText);
        const matchesAssignee = !filterAssignee || t.assignee === filterAssignee;
        const matchesProject = !projectParam || t.project === projectParam;
        return matchesText && matchesAssignee && matchesProject;
      });

      STATUSES.forEach(status => {
        if(!visibleColumns.includes(status)) return;

        const col = document.createElement("section");
        col.className = "kanban-column";
        col.dataset.status = status;
        col.innerHTML = `
          <header class="flex items-center justify-between">
            <span class="col-title">${status}</span>
            <div class="flex items-center gap-sm">
              <span class="text-tertiary" id="count-${status.replace(/\s/g,'')}">0</span>
              <button class="btn btn-secondary" onclick="openCreateTask('${status}')" aria-label="Add task to ${status}">+ Task</button>
            </div>
          </header>
          <div class="kanban-list" role="list" aria-labelledby="col-${status}">
          </div>
        `;
        const list = col.querySelector(".kanban-list");

        // Allow drops
        list.addEventListener("dragover", e => {
          e.preventDefault();
          list.classList.add("kanban-drop-target");
        });
        list.addEventListener("dragleave", () => list.classList.remove("kanban-drop-target"));
        list.addEventListener("drop", e => {
          e.preventDefault();
          list.classList.remove("kanban-drop-target");
          const id = e.dataTransfer.getData("text/plain");
          moveTaskToStatus(id, status);
        });

        // Cards
        const cards = filtered.filter(t => t.status === status);
        cards.forEach(t => list.appendChild(renderCard(t)));
        col.querySelector(`#count-${status.replace(/\s/g,'')}`).textContent = cards.length;

        $board.appendChild(col);
      });
    }

    function renderCard(t){
      const card = document.createElement("article");
      card.className = "kanban-card";
      card.setAttribute("draggable","true");
      card.id = t.id;
      const depBadge = t.deps && t.deps.length ? `<span title="Has dependencies" aria-label="dependencies">‚õìÔ∏è</span>` : "";
      const priorityDot = t.priority==="High" ? "üî¥" : t.priority==="Medium" ? "üü†" : "üü¢";
      card.innerHTML = `
        <div class="flex justify-between items-center">
          <strong>${escapeHtml(t.title)}</strong>
          <span title="Priority">${priorityDot}</span>
        </div>
        <div class="text-tertiary" style="margin-top:.25rem; font-size:.9rem;">${escapeHtml(t.desc)}</div>
        <div class="flex items-center gap-sm" style="margin-top:.4rem; font-size:.85rem;">
          <span title="Assignee">üë§ ${escapeHtml(t.assignee)}</span>
          ${t.due ? `<span title="Due date">üóìÔ∏è ${t.due}</span>` : ""}
          ${depBadge}
        </div>
      `;

      // Drag handlers
      card.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", t.id);
        requestAnimationFrame(()=>card.classList.add("dragging"));
      });
      card.addEventListener("dragend", ()=> card.classList.remove("dragging"));

      // Click to open details
      card.addEventListener("click", ()=> openTask(t.id));
      return card;
    }

    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[m])); }

    // ---------- Actions ----------
    function moveTaskToStatus(id, status){
      const idx = tasks.findIndex(x=>x.id===id);
      if(idx===-1) return;
      // Dependency guard: cannot move to In Progress if has unmet deps
      if(status==="In Progress" && tasks[idx].deps && tasks[idx].deps.length){
        const unmet = tasks[idx].deps.filter(d => (tasks.find(x=>x.id===d)||{}).status !== "Done");
        if(unmet.length){
          showToast("Cannot start ‚Äì dependencies not Done.");
          return;
        }
      }
      tasks[idx].status = status;
      storage.saveTasks(tasks);
      renderBoard();
    }

    function applyFilters(){
      filterText = document.getElementById("searchTasks").value.trim().toLowerCase();
      filterAssignee = document.getElementById("assigneeFilter").value;
      renderBoard();
    }

    // ---------- Task Details ----------
    function openTask(id){
      const t = tasks.find(x=>x.id===id);
      if(!t) return;

      // Prefer full app modal if available
      if(window.atlas && typeof window.atlas.showTaskDetailModal === "function"){
        window.atlas.showTaskDetailModal(t);
        return;
      }

      // Fallback sheet
      const sheet = document.getElementById("taskSheet");
      const content = document.getElementById("sheetContent");
      document.getElementById("sheetTitle").textContent = t.title;

      const depsHtml = (t.deps||[]).map(d=>{
        const dTask = tasks.find(x=>x.id===d);
        const done = dTask && dTask.status==="Done";
        return `<li>${done?"‚úÖ":"‚è≥"} ${escapeHtml(dTask?dTask.title:d)}</li>`;
      }).join('');

      content.innerHTML = `
        <div class="task-meta">
          <div><strong>Status:</strong> ${t.status}</div>
          <div><strong>Assignee:</strong> ${escapeHtml(t.assignee)}</div>
          <div><strong>Priority:</strong> ${escapeHtml(t.priority)}</div>
          <div><strong>Due:</strong> ${t.due || "‚Äî"}</div>
        </div>
        <div class="divider"></div>
        <p>${escapeHtml(t.desc)}</p>
        ${t.deps && t.deps.length ? `<div class="divider"></div><div><strong>Dependencies</strong><ul>${depsHtml}</ul></div>` : ""}
        <div class="divider"></div>
        <div class="flex gap-sm">
          ${STATUSES.filter(s=>s!==t.status && visibleColumns.includes(s)).map(s=>`<button class="btn btn-secondary" onclick="moveTaskToStatus('${t.id}','${s}')">Move to ${s}</button>`).join('')}
          <button class="btn" onclick="markDone('${t.id}')">Mark Done</button>
        </div>
      `;
      sheet.classList.add("open");
    }

    function closeTaskSheet(){ document.getElementById("taskSheet").classList.remove("open"); }
    function markDone(id){ moveTaskToStatus(id,"Done"); closeTaskSheet(); }

    // ---------- Create Task / Columns Dialog ----------
    function openCreateTask(defaultStatus){
      const modalRoot = document.getElementById("modalRoot");
      const backdrop = document.getElementById("backdrop");
      const title = "Create Task";
      modalRoot.innerHTML = `
        <div class="modal-panel" role="dialog" aria-modal="true" aria-label="${title}">
          <div class="modal-header">
            <h3 class="modal-title">${title}</h3>
            <button class="modal-close" aria-label="Close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-grid">
              <label for="new_title">Title *</label>
              <input id="new_title" class="input" placeholder="e.g. Schedule plumbing inspection"/>
              <label for="new_desc">Description</label>
              <textarea id="new_desc" class="input" placeholder="Add helpful context"></textarea>
              <div class="form-row">
                <div>
                  <label for="new_status">Status</label>
                  <select id="new_status" class="input">
                    ${STATUSES.map(s=>`<option ${defaultStatus===s?"selected":""}>${s}</option>`).join("")}
                  </select>
                </div>
                <div>
                  <label for="new_assignee">Assignee</label>
                  <select id="new_assignee" class="input">
                    <option>Andrew</option><option>Katie</option><option>Contractor</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div>
                  <label for="new_priority">Priority</label>
                  <select id="new_priority" class="input">
                    <option>Low</option><option selected>Medium</option><option>High</option>
                  </select>
                </div>
                <div>
                  <label for="new_due">Due Date</label>
                  <input id="new_due" type="date" class="input"/>
                </div>
              </div>
              <label for="new_deps">Dependencies (comma IDs)</label>
              <input id="new_deps" class="input" placeholder="e.g. t4,t6"/>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="btn" onclick="createTask()">Create Task</button>
          </div>
        </div>
      `;
      backdrop.classList.add("show");
      modalRoot.classList.add("open");
      document.body.classList.add("atlas-modal-open");
    }

    function openColumnsDialog(){
      const modalRoot = document.getElementById("modalRoot");
      const backdrop = document.getElementById("backdrop");
      const title = "Choose Visible Columns";
      modalRoot.innerHTML = `
        <div class="modal-panel" role="dialog" aria-modal="true" aria-label="${title}">
          <div class="modal-header">
            <h3 class="modal-title">${title}</h3>
            <button class="modal-close" aria-label="Close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-grid">
              ${STATUSES.map(s=>`
                <label style="display:flex;align-items:center;gap:.5rem;">
                  <input type="checkbox" value="${s}" ${visibleColumns.includes(s)?"checked":""}
                         onchange="toggleColumnVisibility(this.value,this.checked)"/>
                  ${s}
                </label>
              `).join("")}
              <div class="text-tertiary">Your selection is saved to this device.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn" onclick="closeModal()">Done</button>
          </div>
        </div>
      `;
      backdrop.classList.add("show");
      modalRoot.classList.add("open");
      document.body.classList.add("atlas-modal-open");
    }

    function closeModal(){
      document.getElementById("modalRoot").innerHTML = "";
      document.getElementById("modalRoot").classList.remove("open");
      document.getElementById("backdrop").classList.remove("show");
      document.body.classList.remove("atlas-modal-open");
    }

    function createTask(){
      const title = document.getElementById("new_title").value.trim();
      if(!title){ showToast("Title is required."); return; }
      const desc = document.getElementById("new_desc").value.trim();
      const status = document.getElementById("new_status").value;
      const assignee = document.getElementById("new_assignee").value;
      const priority = document.getElementById("new_priority").value;
      const due = document.getElementById("new_due").value;
      const deps = document.getElementById("new_deps").value.trim();
      const id = "t" + Math.random().toString(36).slice(2,7);

      tasks.push({
        id, title, desc,
        status, assignee, priority, due,
        deps: deps ? deps.split(",").map(s=>s.trim()).filter(Boolean) : [],
        project: projectParam || "general"
      });
      storage.saveTasks(tasks);
      closeModal();
      renderBoard();
      showToast("Task created.");
    }

    function toggleColumnVisibility(col, on){
      if(on && !visibleColumns.includes(col)) visibleColumns.push(col);
      if(!on) visibleColumns = visibleColumns.filter(c=>c!==col);
      if(!visibleColumns.length){ visibleColumns = DEFAULT_VISIBLE.slice(); }
      storage.saveVisible(visibleColumns);
      renderBoard();
    }

    // ---------- Toast ----------
    let toastTimer;
    function showToast(msg, type="info"){
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.className = "toast info";
        document.body.appendChild(el);
      }
      el.className = `toast ${type}`;
      el.textContent = msg;
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> el.remove(), 2200);
    }

    // ---------- Init ----------
    renderBoard();
  </script>

  <!-- App script (if present, enhances task modals, persistence with backend, etc.) -->
  <script src="atlas-interactive.js"></script>
</body>
</html>
