<!-- File: calendar.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Project Calendar - Plan, track, and review project events in Project Atlas"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Calendar - Project Atlas</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“…</text></svg>'">

  <!-- Shared base styles -->
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>

  <style>
    /* ===== Page container ===== */
    .page-wrap{padding:var(--space-xl);max-width:1600px;margin:0 auto}

    /* ===== Header ===== */
    .cal-header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:var(--space-lg);margin-bottom:var(--space-lg)}
    .cal-title h2{margin-bottom:6px}
    .subtle{color:var(--text-secondary);font-size:.95rem}

    /* ===== Toolbar ===== */
    .toolbar{
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;
      background:var(--bg-elevated);border:1px solid var(--border-light);
      border-radius:var(--radius-lg);padding:10px 12px;margin-bottom:var(--space-xl);
    }
    .toolbar .left{display:flex;align-items:center;gap:8px}
    .toolbar .center{display:flex;align-items:center;gap:8px;flex:1;min-width:260px}
    .toolbar .right{display:flex;align-items:center;gap:8px;margin-left:auto}

    .btn-chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border-default);border-radius:var(--radius-md);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer}
    .btn-chip:hover{border-color:var(--app-primary);background:var(--app-primary-lighter);color:var(--app-primary)}
    .btn-icon{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border-default);border-radius:var(--radius-md);background:var(--bg-secondary);color:var(--text-primary);cursor:pointer}
    .btn-icon:hover{border-color:var(--app-primary);background:var(--app-primary-lighter);color:var(--app-primary)}
    .toggle{display:inline-flex;border:1px solid var(--border-default);border-radius:var(--radius-md);overflow:hidden}
    .toggle button{padding:8px 12px;border:0;background:var(--bg-secondary);color:var(--text-secondary);cursor:pointer}
    .toggle button.active{background:var(--app-primary);color:#fff}

    .search{position:relative;flex:1}
    .search input{width:100%;padding:8px 34px 8px 10px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:var(--radius-md)}
    .search .icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);opacity:.6}

    select.input{padding:8px 10px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:var(--radius-md)}

    /* ===== Layout ===== */
    .layout{display:grid;grid-template-columns:1fr 320px;gap:var(--space-xl)}
    @media (max-width:1100px){ .layout{grid-template-columns:1fr} }

    /* ===== Calendar frame ===== */
    .cal-frame{
      background:var(--bg-secondary);border:1px solid var(--border-default);
      border-radius:var(--radius-xl);padding:12px;box-shadow:var(--shadow-sm);
    }
    .cal-nav{display:flex;align-items:center;gap:10px;justify-content:center;margin-bottom:8px}
    .cal-nav .btn-mini{width:30px;height:30px;border:1px solid var(--border-default);border-radius:999px;background:var(--bg-secondary);display:flex;align-items:center;justify-content:center;cursor:pointer}
    .cal-nav .btn-mini:hover{border-color:var(--app-primary);color:var(--app-primary)}
    .cal-current{min-width:220px;text-align:center;font-weight:700}

    /* ===== Month grid ===== */
    .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:0;border-top:1px solid var(--border-light);border-left:1px solid var(--border-light);border-radius:var(--radius-lg);overflow:hidden}
    .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:0;margin:8px 6px 8px 6px;color:var(--text-secondary);font-weight:600}
    .cell{
      min-height:110px;background:var(--bg-secondary);border-right:1px solid var(--border-light);border-bottom:1px solid var(--border-light);padding:6px 6px 4px 6px;position:relative;cursor:default
    }
    .cell:hover{background:var(--bg-elevated)}
    .cell .date{font-size:.85rem;color:var(--text-secondary);margin-bottom:6px}
    .cell.out{background:rgba(0,0,0,.03)}
    .cell.today{outline:2px solid var(--app-primary);outline-offset:-2px;border-radius:6px}
    .cell .add{position:absolute;right:6px;top:4px;opacity:.6;cursor:pointer}
    .cell .add:hover{opacity:1}
    .pill{
      display:block;max-width:100%;padding:3px 8px;margin:4px 0;border-radius:999px;
      color:#fff;font-size:.78rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    /* Project colors */
    .kitchen{background:#1d73e8}
    .bathroom{background:#ff9800}
    .basement{background:#43a047}
    .milestone{background:#ef5350}

    /* ===== Week view ===== */
    .week-wrap{display:grid;grid-template-columns:80px 1fr;gap:0;border-top:1px solid var(--border-light);border-left:1px solid var(--border-light);border-radius:var(--radius-lg);overflow:hidden}
    .week-hours{display:grid;grid-template-rows:repeat(24,50px)}
    .week-hours div{border-bottom:1px dashed var(--border-light);padding:4px 6px;color:var(--text-secondary);font-variant-numeric:tabular-nums}
    .week-grid{display:grid;grid-template-columns:repeat(7,1fr)}
    .week-col{border-right:1px solid var(--border-light);position:relative}
    .week-col .slot{height:50px;border-bottom:1px solid var(--border-light);cursor:crosshair}
    .event-block{
      position:absolute;left:6px;right:6px;border-radius:8px;padding:6px 8px;color:#fff;font-size:.78rem;box-shadow:var(--shadow-sm);cursor:pointer
    }

    /* ===== Day view ===== */
    .day-wrap{display:grid;grid-template-columns:80px 1fr;border:1px solid var(--border-light);border-radius:var(--radius-lg);overflow:hidden}
    .day-hours{display:grid;grid-template-rows:repeat(24,52px)}
    .day-hours div{border-bottom:1px dashed var(--border-light);padding:4px 6px;color:var(--text-secondary);font-variant-numeric:tabular-nums}
    .day-col{position:relative}
    .day-col .slot{height:52px;border-bottom:1px solid var(--border-light);cursor:crosshair}

    /* ===== Sidebar cards ===== */
    .card{background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);box-shadow:var(--shadow-sm)}
    .card-header{padding:12px 16px;border-bottom:1px solid var(--border-light);font-weight:700}
    .card-body{padding:12px 16px}
    .legend li{display:flex;align-items:center;gap:10px;margin:6px 0}
    .legend .dot{width:10px;height:10px;border-radius:999px}
    .legend .kitchen{background:#1d73e8}.legend .bathroom{background:#ff9800}.legend .basement{background:#43a047}.legend .milestone{background:#ef5350}
    .list-plain{display:flex;flex-direction:column;gap:10px}
    .list-plain .row{display:flex;justify-content:space-between;gap:10px}

    /* ===== Modal & toast (shared pattern) ===== */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:1000}
    .modal-backdrop.show{opacity:1;pointer-events:auto}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:1001}
    .modal.open{opacity:1;pointer-events:auto}
    .modal-panel{width:min(800px,94vw);max-height:90vh;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);box-shadow:var(--shadow-lg);display:flex;flex-direction:column;overflow:hidden}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border-light)}
    .modal-title{font-size:1.125rem}
    .modal-close{background:transparent;border:0;font-size:1.5rem;cursor:pointer;color:var(--text-secondary)}
    .modal-body{padding:16px;overflow:auto}
    .modal-footer{padding:12px 16px;border-top:1px solid var(--border-light);display:flex;gap:10px;justify-content:flex-end}

    .input, select.input, .textarea{width:100%;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:8px;padding:10px}
    .textarea{min-height:80px}

    /* Utility */
    .muted{color:var(--text-secondary)}
    .pill-outline{display:inline-flex;align-items:center;gap:8px;padding:3px 10px;border-radius:999px;border:1px solid var(--border-light);font-size:.8rem}
    .btn{padding:10px 14px;border:1px solid var(--border-default);border-radius:var(--radius-md);background:var(--bg-secondary);cursor:pointer}
    .btn:hover{border-color:var(--app-primary);color:var(--app-primary)}
    .btn-primary{background:var(--app-primary);border-color:var(--app-primary);color:#fff}
    .btn-primary:hover{filter:brightness(.98)}

    /* --- FIX: High-contrast buttons & modal overrides --- */
    .btn, .btn-icon { font-weight:600; letter-spacing:.01em; }
    .btn-primary{
      background:var(--app-primary)!important;
      border-color:var(--app-primary)!important;
      color:#fff!important;
    }
    .btn-primary:hover,
    .btn-primary:focus{
      filter:brightness(.95);
      color:#fff!important;
    }
    .modal-footer .btn-primary{
      background-color:var(--app-primary)!important;
      border-color:var(--app-primary)!important;
      color:#fff!important;
      font-weight:600!important;
      text-shadow:0 0 2px rgba(0,0,0,.25);
      min-width:90px;
      padding:10px 16px;
      border-radius:var(--radius-md);
    }
    .modal-footer .btn-primary:hover,
    .modal-footer .btn-primary:focus{
      background-color:color-mix(in srgb, var(--app-primary) 90%, black);
      color:#fff!important;
    }
    .modal-footer .btn{
      background-color:var(--bg-secondary);
      color:var(--text-secondary);
      border:1px solid var(--border-light);
      min-width:90px;
      padding:10px 16px;
      border-radius:var(--radius-md);
    }

    .visually-hidden{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}

    @media (max-width:720px){
      .toolbar{gap:8px}
      .cal-current{min-width:auto}
      .dow{display:none}
      .cell{min-height:90px}
    }
  </style>
</head>
<body class="app-page">
  <a href="#main" class="skip-to-main">Skip to content</a>

  <!-- Header -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>

      <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="mainNav">
        <span aria-hidden="true">â˜°</span>
      </button>

      <nav class="main-nav" id="mainNav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="kanban.html">Kanban Board</a></li>
          <li><a href="budget.html">Budget Tracker</a></li>
          <li><a href="calendar.html" class="active" aria-current="page">Calendar</a></li>
          <li><a href="documents.html">Documents</a></li>
        </ul>
      </nav>

      <!-- Avatar only; "+Schedule Task" moved into toolbar -->
      <div class="user-menu">
        <button class="user-avatar" aria-label="User menu" title="User Menu">AF</button>
      </div>
    </div>
  </header>

  <main id="main" class="page-wrap">
    <div class="cal-header">
      <div class="cal-title">
        <h2>Project Calendar</h2>
        <div class="subtle" id="subtitle"></div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar" role="region" aria-label="Calendar tools">
      <div class="left">
        <button class="btn-icon btn-mini" aria-label="Previous" onclick="previousNav()">â€¹</button>
        <button class="btn-chip" onclick="goToToday()">Today</button>
        <button class="btn-icon btn-mini" aria-label="Next" onclick="nextNav()">â€º</button>
      </div>

      <div class="center">
        <div class="cal-current" id="currentLabel">October 2025</div>

        <div class="search">
          <input id="searchInput" type="search" placeholder="Search eventsâ€¦ (title, note, tag)" />
          <span class="icon">ðŸ”Ž</span>
        </div>

        <select id="projectFilter" class="input" aria-label="Filter by project" style="min-width:160px">
          <option value="all">All Projects</option>
          <option value="kitchen">Kitchen Renovation</option>
          <option value="bathroom">Bathroom Update</option>
          <option value="basement">Basement Finishing</option>
        </select>

        <select id="typeFilter" class="input" aria-label="Filter by type" style="min-width:140px">
          <option value="all">All Types</option>
          <option value="task">Task</option>
          <option value="inspection">Inspection</option>
          <option value="meeting">Meeting</option>
          <option value="deadline">Deadline/Milestone</option>
        </select>
      </div>

      <div class="right">
        <!-- Moved here from top nav -->
        <button class="btn-icon btn-primary" onclick="openNewEventModal()"><span aria-hidden="true">ï¼‹</span> Schedule Task</button>

        <div class="toggle" role="group" aria-label="View">
          <button id="btnMonth" class="active" onclick="setView('month')">Month</button>
          <button id="btnWeek" onclick="setView('week')">Week</button>
          <button id="btnDay" onclick="setView('day')">Day</button>
        </div>
      </div>
    </div>

    <div class="layout">
      <!-- Calendar -->
      <section>
        <div class="cal-frame">
          <div id="calendarRoot"></div>
        </div>
      </section>

      <!-- Sidebar -->
      <aside>
        <section class="card">
          <div class="card-header">Upcoming This Week</div>
          <div class="card-body" id="upcomingList">
            <div class="muted">No events scheduled this week.</div>
          </div>
        </section>

        <section class="card" style="margin-top:var(--space-lg)">
          <div class="card-header">Project Color Key</div>
          <div class="card-body">
            <ul class="legend">
              <li><span class="dot kitchen"></span> Kitchen Renovation</li>
              <li><span class="dot bathroom"></span> Bathroom Update</li>
              <li><span class="dot basement"></span> Basement Finishing</li>
              <li><span class="dot milestone"></span> Deadlines & Milestones</li>
            </ul>
          </div>
        </section>

        <section class="card" style="margin-top:var(--space-lg)">
          <div class="card-header">This Month</div>
          <div class="card-body">
            <div class="list-plain" id="monthStats">
              <div class="row"><span>Total Events</span><strong>0</strong></div>
              <div class="row"><span>Inspections</span><strong>0</strong></div>
              <div class="row"><span>Deadlines</span><strong>0</strong></div>
              <div class="row"><span>Contractor Meetings</span><strong>0</strong></div>
            </div>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <!-- Modal & Backdrop -->
  <div id="backdrop" class="modal-backdrop"></div>
  <div id="modalRoot" class="modal" aria-hidden="true"></div>

  <script>
    /* ===== Header menu (responsive) ===== */
    function toggleMobileMenu(){
      const nav = document.getElementById('mainNav');
      const toggle = document.querySelector('.mobile-menu-toggle');
      const isExpanded = nav.classList.toggle('active');
      toggle.setAttribute('aria-expanded', String(isExpanded));
    }

    /* ===== Utilities ===== */
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Los_Angeles';
    const fmtDay = (d)=> new Intl.DateTimeFormat(undefined,{weekday:'short'}).format(d);
    const fmtMonth = (d)=> new Intl.DateTimeFormat(undefined,{month:'long'}).format(d);
    const fmtMonthYear = (d)=> new Intl.DateTimeFormat(undefined,{month:'long', year:'numeric'}).format(d);
    const fmtDateShort = (d)=> new Intl.DateTimeFormat(undefined,{month:'short', day:'numeric'}).format(d);
    const fmtDateTime = (d)=> new Intl.DateTimeFormat(undefined,{month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}).format(d);

    function startOfWeek(d){
      const day = (d.getDay()+7)%7; // 0=Sun
      const start = new Date(d); start.setDate(d.getDate()-day); start.setHours(0,0,0,0); return start;
    }
    function endOfWeek(d){ const s = startOfWeek(d); const e = new Date(s); e.setDate(s.getDate()+6); e.setHours(23,59,59,999); return e; }
    function startOfMonth(d){ const m = new Date(d.getFullYear(), d.getMonth(), 1); m.setHours(0,0,0,0); return m; }
    function endOfMonth(d){ const e = new Date(d.getFullYear(), d.getMonth()+1, 0); e.setHours(23,59,59,999); return e; }
    function clampDate(d){ const c = new Date(d); c.setSeconds(0,0); return c; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

    function toast(msg){
      let t = document.getElementById('atlas-toast');
      if(!t){
        t = document.createElement('div');
        t.id='atlas-toast';
        t.style.cssText='position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0b3a75;color:#fff;border-radius:10px;padding:10px 14px;box-shadow:0 8px 20px rgba(0,0,0,.2);z-index:1200;opacity:0;transition:opacity .15s ease';
        document.body.appendChild(t);
      }
      t.textContent = msg; t.style.opacity = '1'; setTimeout(()=>t.style.opacity='0', 1400);
    }

    /* ===== Modal helpers ===== */
    function openModal(title, html, footerHtml){
      const modalRoot = document.getElementById("modalRoot");
      const backdrop  = document.getElementById("backdrop");
      modalRoot.innerHTML = `
        <div class="modal-panel" role="dialog" aria-modal="true" aria-label="${(title||'').replace(/"/g,'&quot;')}">
          <div class="modal-header">
            <h3 class="modal-title">${title||''}</h3>
            <button class="modal-close" aria-label="Close" onclick="closeModal()">&times;</button>
          </div>
          <div class="modal-body">${html||''}</div>
          <div class="modal-footer">${footerHtml || '<button class="btn" onclick="closeModal()">Close</button>'}</div>
        </div>`;
      backdrop.classList.add("show");
      modalRoot.classList.add("open");
      document.body.classList.add("atlas-modal-open");
    }
    function closeModal(){
      document.getElementById("modalRoot").classList.remove("open");
      document.getElementById("backdrop").classList.remove("show");
      document.getElementById("modalRoot").innerHTML = "";
      document.body.classList.remove("atlas-modal-open");
    }

    /* ===== Data store ===== */
    const CalendarStore = {
      key: 'atlas.events.v1',
      read(){ try{ return JSON.parse(localStorage.getItem(this.key))||[] } catch { return [] } },
      write(list){ localStorage.setItem(this.key, JSON.stringify(list)) },
      ensureSeed(){
        if(this.read().length) return;
        const now = new Date();
        const seed = [
          // sample events near current month for visual proof
          ev('Kitchen Plan Review','kitchen','meeting', addDays(startOfMonth(now), 8), '10:00', '11:00', 'Discuss layout with GC', false),
          ev('Basement Inspection','basement','inspection', addDays(startOfMonth(now), 12), '09:00', '10:00', 'Framing/rough-in', false),
          ev('Tile Delivery','bathroom','task', addDays(startOfMonth(now), 15), '14:00', '15:00', 'Confirm with supplier', false),
          ev('Countertop Template','kitchen','deadline', addDays(startOfMonth(now), 18), '00:00', '23:59', 'Measure for slab', true),
        ];
        this.write(seed);
      }
    };
    function ev(title, project, type, dateObj, startHHMM, endHHMM, notes, allDay){
      const y = dateObj.getFullYear(), m = dateObj.getMonth(), d = dateObj.getDate();
      const [sh, sm] = startHHMM.split(':').map(Number);
      const [eh, em] = endHHMM.split(':').map(Number);
      return {
        id: 'e' + Math.random().toString(36).slice(2,9),
        title, project, type,
        start: new Date(y, m, d, sh, sm).toISOString(),
        end: new Date(y, m, d, eh, em).toISOString(),
        allDay: !!allDay,
        notes: notes||'',
        tags: []
      };
    }
    CalendarStore.ensureSeed();

    /* ===== State ===== */
    const state = {
      view: 'month',              // 'month' | 'week' | 'day'
      cursor: startOfMonth(new Date()), // anchor date for current view
      query: '',
      project: 'all',
      type: 'all'
    };

    /* ===== Elements & wiring ===== */
    const elLabel = document.getElementById('currentLabel');
    const elSubtitle = document.getElementById('subtitle');
    const elRoot = document.getElementById('calendarRoot');

    document.getElementById('searchInput').addEventListener('input', (e)=>{ state.query = e.target.value.trim(); render(); });
    document.getElementById('projectFilter').addEventListener('change', (e)=>{ state.project = e.target.value; render(); });
    document.getElementById('typeFilter').addEventListener('change', (e)=>{ state.type = e.target.value; render(); });

    function setView(mode){
      state.view = mode;
      document.getElementById('btnMonth').classList.toggle('active', mode==='month');
      document.getElementById('btnWeek').classList.toggle('active', mode==='week');
      document.getElementById('btnDay').classList.toggle('active', mode==='day');

      // normalize cursor anchor for each mode
      if(mode==='month') state.cursor = startOfMonth(state.cursor);
      render();
    }

    function shiftCursor({ months=0, days=0 }){
      const d = new Date(state.cursor);
      if(months){
        state.cursor = new Date(d.getFullYear(), d.getMonth()+months, 1);
      }else if(days){
        state.cursor = addDays(d, days);
      }
      render();
    }
    function previousNav(){
      if(state.view==='month') shiftCursor({ months:-1 });
      else if(state.view==='week') shiftCursor({ days:-7 });
      else shiftCursor({ days:-1 });
    }
    function nextNav(){
      if(state.view==='month') shiftCursor({ months:1 });
      else if(state.view==='week') shiftCursor({ days:7 });
      else shiftCursor({ days:1 });
    }
    function goToToday(){
      const today = new Date();
      state.cursor = state.view==='month' ? startOfMonth(today) : today;
      render();
    }

    /* ===== Filters ===== */
    function applyFilters(rows){
      const q = state.query.toLowerCase();
      return rows.filter(r=>{
        if(state.project!=='all' && r.project!==state.project) return false;
        if(state.type!=='all' && r.type!==state.type) return false;
        if(q){
          const hay = [r.title, r.notes, ...(r.tags||[])].join(' ').toLowerCase();
          if(!hay.includes(q)) return false;
        }
        return true;
      });
    }

    /* ===== Rendering ===== */
    function render(){
      const label = state.view==='month'
        ? fmtMonthYear(state.cursor)
        : state.view==='week'
          ? `${fmtDateShort(startOfWeek(state.cursor))} â€“ ${fmtDateShort(endOfWeek(state.cursor))}`
          : fmtDateTime(state.cursor);
      elLabel.textContent = label;
      elSubtitle.textContent = fmtMonthYear(new Date());

      const events = applyFilters(CalendarStore.read());

      if(state.view==='month') renderMonth(events);
      else if(state.view==='week') renderWeek(events);
      else renderDay(events);

      renderUpcoming(events);
      renderStats(events);
    }

    function renderMonth(events){
      const root = document.createElement('div');
      const dow = document.createElement('div');
      dow.className = 'dow';
      ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
        const s = document.createElement('div'); s.textContent = d; dow.appendChild(s);
      });
      root.appendChild(dow);

      const grid = document.createElement('div');
      grid.className = 'month-grid';

      const first = startOfMonth(state.cursor);
      const start = startOfWeek(first);
      const last = endOfMonth(state.cursor);
      const end = addDays(startOfWeek(addDays(last, 7)), 6); // ensures full 6 weeks

      let day = new Date(start);
      while(day <= end){
        const cell = document.createElement('div');
        cell.className = 'cell';
        if(day.getMonth()!==state.cursor.getMonth()) cell.classList.add('out');
        const today = new Date(); if(day.toDateString()===today.toDateString()) cell.classList.add('today');

        cell.innerHTML = `<div class="date">${day.getDate()}</div><div class="add" title="Add" onclick="openNewEventModal('${day.toISOString()}', event)">ï¼‹</div>`;

        // render events of this date
        const todays = events.filter(e=>{
          const sd = new Date(e.start);
          return sd.getFullYear()===day.getFullYear() &&
                 sd.getMonth()===day.getMonth() &&
                 sd.getDate()===day.getDate();
        });
        todays.sort((a,b)=> new Date(a.start) - new Date(b.start));
        todays.forEach(e=>{
          const a = document.createElement('a');
          a.className = `pill ${colorClass(e)}`;
          a.textContent = e.title;
          a.title = `${e.title} â€¢ ${fmtDateTime(new Date(e.start))}`;
          a.href = 'javascript:void(0)';
          a.onclick = (ev)=>{ ev.stopPropagation(); openEventModal(e.id); };
          cell.appendChild(a);
        });

        cell.addEventListener('dblclick', ()=> openNewEventModal(day.toISOString()));
        grid.appendChild(cell);
        day = addDays(day, 1);
      }
      root.appendChild(grid);

      elRoot.innerHTML = '';
      elRoot.appendChild(root);
    }

    function renderWeek(events){
      const root = document.createElement('div');
      root.className = 'week-wrap';

      const hours = document.createElement('div');
      hours.className = 'week-hours';
      for(let h=0; h<24; h++){
        const r = document.createElement('div'); r.textContent = (h+'').padStart(2,'0') + ':00';
        hours.appendChild(r);
      }
      root.appendChild(hours);

      const grid = document.createElement('div');
      grid.className = 'week-grid';

      const s = startOfWeek(state.cursor);
      for(let i=0;i<7;i++){
        const day = addDays(s, i);
        const col = document.createElement('div');
        col.className = 'week-col';

        // hourly slots (click to add)
        for(let h=0; h<24; h++){
          const slot = document.createElement('div');
          slot.className = 'slot';
          slot.title = `Add ${fmtDateShort(day)} ${String(h).padStart(2,'0')}:00`;
          slot.onclick = ()=> openNewEventModal(new Date(day.getFullYear(), day.getMonth(), day.getDate(), h, 0).toISOString());
          col.appendChild(slot);
        }

        // place events
        const dayEvents = events.filter(e=>{
          const sd = new Date(e.start);
          return sd.toDateString()===day.toDateString();
        });
        dayEvents.forEach(e=>{
          const sd = new Date(e.start), ed = new Date(e.end);
          const top = (sd.getHours()*50) + (sd.getMinutes()/60)*50; // 50px per hour
          const height = Math.max(26, ((ed - sd)/3600000)*50);
          const block = document.createElement('div');
          block.className = `event-block ${colorClass(e)}`;
          block.style.top = (top+2)+'px'; block.style.height = (height-4)+'px';
          block.textContent = e.title;
          block.onclick = ()=> openEventModal(e.id);
          col.appendChild(block);
        });

        grid.appendChild(col);
      }
      root.appendChild(grid);

      elRoot.innerHTML = '';
      elRoot.appendChild(root);
    }

    function renderDay(events){
      const root = document.createElement('div');
      root.className = 'day-wrap';

      const hours = document.createElement('div'); hours.className='day-hours';
      for(let h=0; h<24; h++){
        const r = document.createElement('div'); r.textContent = (h+'').padStart(2,'0') + ':00';
        hours.appendChild(r);
      }
      root.appendChild(hours);

      const col = document.createElement('div'); col.className='day-col';
      for(let h=0; h<24; h++){
        const slot = document.createElement('div'); slot.className='slot';
        slot.title = `Add ${fmtDateShort(state.cursor)} ${String(h).padStart(2,'0')}:00`;
        slot.onclick = ()=> openNewEventModal(new Date(state.cursor.getFullYear(), state.cursor.getMonth(), state.cursor.getDate(), h, 0).toISOString());
        col.appendChild(slot);
      }

      const todays = events.filter(e=> new Date(e.start).toDateString()===state.cursor.toDateString());
      todays.forEach(e=>{
        const sd = new Date(e.start), ed = new Date(e.end);
        const top = (sd.getHours()*52) + (sd.getMinutes()/60)*52;
        const height = Math.max(28, ((ed - sd)/3600000)*52);
        const block = document.createElement('div');
        block.className = `event-block ${colorClass(e)}`;
        block.style.top = (top+2)+'px'; block.style.height = (height-4)+'px';
        block.textContent = e.title;
        block.onclick = ()=> openEventModal(e.id);
        col.appendChild(block);
      });

      root.appendChild(col);
      elRoot.innerHTML = '';
      elRoot.appendChild(root);
    }

    function colorClass(e){
      if(e.type==='deadline') return 'milestone';
      return e.project; // kitchen | bathroom | basement
    }

    /* ===== Sidebar ===== */
    function renderUpcoming(events){
      const list = document.getElementById('upcomingList');
      const start = startOfWeek(new Date());
      const end = endOfWeek(new Date());
      const rows = events.filter(e=>{
        const sd = new Date(e.start); return sd>=start && sd<=end;
      }).sort((a,b)=> new Date(a.start)-new Date(b.start));

      if(!rows.length){ list.innerHTML = '<div class="muted">No events scheduled this week.</div>'; return; }

      list.innerHTML = rows.map(e=>`
        <div class="row" style="align-items:center">
          <span class="pill-outline">
            <span class="dot ${colorClass(e)}" style="width:8px;height:8px;border-radius:999px"></span>
            ${e.title}
          </span>
          <span class="muted">${fmtDateTime(new Date(e.start))}</span>
        </div>
      `).join('');
    }

    function renderStats(events){
      const s = document.getElementById('monthStats');
      const start = startOfMonth(state.cursor), end = endOfMonth(state.cursor);
      const rows = events.filter(e=> {
        const sd = new Date(e.start); return sd>=start && sd<=end;
      });
      const count = (t)=> rows.filter(e=> e.type === t).length;
      s.innerHTML = `
        <div class="row"><span>Total Events</span><strong>${rows.length}</strong></div>
        <div class="row"><span>Inspections</span><strong>${count('inspection')}</strong></div>
        <div class="row"><span>Deadlines</span><strong>${count('deadline')}</strong></div>
        <div class="row"><span>Contractor Meetings</span><strong>${count('meeting')}</strong></div>
      `;
    }

    /* ===== Create / Edit Events ===== */
    function openNewEventModal(dateIso, ev){
      if(ev) ev.stopPropagation();
      const base = dateIso ? new Date(dateIso) : new Date(state.cursor);
      const y = base.getFullYear(), m = base.getMonth(), d = base.getDate();
      const sh = String(base.getHours()).padStart(2,'0');
      const sm = String(base.getMinutes()).padStart(2,'0');
      const eh = String((base.getHours()+1)%24).padStart(2,'0');

      openModal('Schedule Task', `
        <div class="meta" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Title</label><input id="ev_title" class="input" placeholder="e.g., Rough-in inspection"/></div>
          <div><label>Project</label>
            <select id="ev_project" class="input">
              <option value="kitchen">Kitchen Renovation</option>
              <option value="bathroom">Bathroom Update</option>
              <option value="basement">Basement Finishing</option>
            </select>
          </div>

          <div><label>Type</label>
            <select id="ev_type" class="input">
              <option value="task">Task</option>
              <option value="inspection">Inspection</option>
              <option value="meeting">Meeting</option>
              <option value="deadline">Deadline/Milestone</option>
            </select>
          </div>
          <div><label>All Day?</label>
            <select id="ev_allDay" class="input">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>

          <div><label>Date</label><input id="ev_date" class="input" type="date" value="${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}" /></div>
          <div><label>Start</label><input id="ev_time" class="input" type="time" value="${sh}:${sm}" /></div>
          <div><label>End</label><input id="ev_time_end" class="input" type="time" value="${eh}:${sm}" /></div>
          <div><label>Tags</label><input id="ev_tags" class="input" placeholder="comma separated"/></div>

          <div style="grid-column:1/3"><label>Notes</label><textarea id="ev_notes" class="textarea" placeholder="Add detailsâ€¦"></textarea></div>
        </div>
      `, `
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" onclick="createEventFromModal()">Create</button>
      `);
    }

    function createEventFromModal(){
      const title = document.getElementById('ev_title').value.trim();
      if(!title){ toast('Title is required.'); return; }
      const project = document.getElementById('ev_project').value;
      const type = document.getElementById('ev_type').value;
      const allDay = document.getElementById('ev_allDay').value === 'yes';
      const date = document.getElementById('ev_date').value;
      const time = document.getElementById('ev_time').value || '09:00';
      const timeEnd = document.getElementById('ev_time_end').value || time;
      const notes = document.getElementById('ev_notes').value;
      const tags = (document.getElementById('ev_tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);

      const [y,mm,dd] = date.split('-').map(Number);
      const [sh,sm] = time.split(':').map(Number);
      const [eh,em] = timeEnd.split(':').map(Number);

      const start = new Date(y, mm-1, dd, sh, sm);
      const end = new Date(y, mm-1, dd, eh, em);

      const list = CalendarStore.read();
      list.push({ id: 'e'+Math.random().toString(36).slice(2,9), title, project, type, start: start.toISOString(), end: end.toISOString(), allDay, notes, tags });
      CalendarStore.write(list);
      closeModal();
      toast('Event created.');
      render();
    }

    function openEventModal(id){
      const list = CalendarStore.read();
      const ev = list.find(x=> x.id===id); if(!ev){ toast('Event not found'); return; }
      const s = new Date(ev.start), e = new Date(ev.end);
      openModal(ev.title, `
        <div class="meta" style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div><label>Title</label><input id="ed_title" class="input" value="${(ev.title||'').replace(/"/g,'&quot;')}"/></div>
          <div><label>Project</label>
            <select id="ed_project" class="input">
              ${['kitchen','bathroom','basement'].map(p=>`<option value="${p}" ${p===ev.project?'selected':''}>${p[0].toUpperCase()+p.slice(1)}</option>`).join('')}
            </select>
          </div>

          <div><label>Type</label>
            <select id="ed_type" class="input">
              ${['task','inspection','meeting','deadline'].map(t=>`<option value="${t}" ${t===ev.type?'selected':''}>${t[0].toUpperCase()+t.slice(1)}</option>`).join('')}
            </select>
          </div>
          <div><label>All Day?</label>
            <select id="ed_allDay" class="input">
              <option value="no" ${ev.allDay?'':'selected'}>No</option>
              <option value="yes" ${ev.allDay?'selected':''}>Yes</option>
            </select>
          </div>

          <div><label>Date</label><input id="ed_date" class="input" type="date" value="${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}-${String(s.getDate()).padStart(2,'0')}" /></div>
          <div><label>Start</label><input id="ed_time" class="input" type="time" value="${String(s.getHours()).padStart(2,'0')}:${String(s.getMinutes()).padStart(2,'0')}" /></div>
          <div><label>End</label><input id="ed_time_end" class="input" type="time" value="${String(e.getHours()).padStart(2,'0')}:${String(e.getMinutes()).padStart(2,'0')}" /></div>
          <div><label>Tags</label><input id="ed_tags" class="input" value="${(ev.tags||[]).join(', ')}"/></div>

          <div style="grid-column:1/2"><label>Notes</label><textarea id="ed_notes" class="textarea">${(ev.notes||'')}</textarea></div>
        </div>
      `, `
        <button class="btn" onclick="deleteEvent('${ev.id}')">Delete</button>
        <button class="btn" onclick="closeModal()">Close</button>
        <button class="btn-primary" onclick="saveEvent('${ev.id}')">Save</button>
      `);
    }

    function saveEvent(id){
      const list = CalendarStore.read();
      const i = list.findIndex(x=> x.id===id); if(i<0){ toast('Not found'); return; }
      const ev = list[i];

      const title = document.getElementById('ed_title').value.trim() || ev.title;
      const project = document.getElementById('ed_project').value;
      const type = document.getElementById('ed_type').value;
      const allDay = document.getElementById('ed_allDay').value === 'yes';
      const date = document.getElementById('ed_date').value;
      const t1 = document.getElementById('ed_time').value || '09:00';
      const t2 = document.getElementById('ed_time_end').value || t1;
      const notes = document.getElementById('ed_notes').value;
      const tags = (document.getElementById('ed_tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);

      const [y,mm,dd] = date.split('-').map(Number);
      const [sh,sm] = t1.split(':').map(Number);
      const [eh,em] = t2.split(':').map(Number);

      ev.title = title;
      ev.project = project;
      ev.type = type;
      ev.allDay = allDay;
      ev.start = new Date(y,mm-1,dd,sh,sm).toISOString();
      ev.end   = new Date(y,mm-1,dd,eh,em).toISOString();
      ev.notes = notes;
      ev.tags  = tags;

      CalendarStore.write(list);
      closeModal();
      toast('Saved.');
      render();
    }

    function deleteEvent(id){
      const list = CalendarStore.read();
      CalendarStore.write(list.filter(x=> x.id!==id));
      closeModal(); toast('Deleted.'); render();
    }

    /* ===== Init ===== */
    (function init(){
      setView('month'); // sets button state
      render();
    })();
  </script>

  <!-- Optional page JS -->
  <script src="atlas-interactive.js"></script>
</body>
</html>
