<!-- File: kanban.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Kanban Board - Project Atlas</title>

  <!-- Shared theme -->
  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>

  <style>
    /* Page scaffold */
    .page-wrap{padding:var(--space-xl);max-width:1600px;margin:0 auto}
    .board-header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px}
    .board-title h2{margin-bottom:6px}
    .muted{color:var(--text-secondary)}

    /* Toolbar (inline with other pages) */
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:var(--bg-elevated);border:1px solid var(--border-light);border-radius:14px;padding:10px 12px;margin-bottom:24px}
    .toolbar .search{position:relative;flex:1 1 420px}
    .toolbar .search input{width:100%;padding:9px 34px 9px 10px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:10px}
    .toolbar .search .icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);opacity:.6}
    .toolbar .select{min-width:200px}
    .toolbar select{width:100%;padding:9px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:10px}
    .toolbar .actions{display:flex;gap:8px;margin-left:auto}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:10px;padding:8px 12px;cursor:pointer;transition:all .15s}
    .btn:hover{border-color:var(--app-primary);background:var(--app-primary-lighter);color:var(--app-primary)}

    /* --- Jira-like board: long/narrow columns with horizontal scrolling --- */
    .kanban{display:flex;gap:12px;align-items:flex-start;overflow-x:auto;padding-bottom:8px}
    .kanban::-webkit-scrollbar{height:10px}
    .kanban::-webkit-scrollbar-thumb{background:var(--border-default);border-radius:10px}

    .k-col{
      flex:0 0 240px;             /* NARROWER columns */
      width:240px;
      background:var(--bg-secondary);
      border:1px solid var(--border-default);
      border-radius:16px;
      box-shadow:var(--shadow-sm);
      display:flex;flex-direction:column;min-height:120px
    }
    .k-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border-bottom:1px solid var(--border-light);position:sticky;top:0;background:var(--bg-secondary);z-index:1}
    .k-title{font-weight:700}
    .k-count{color:var(--text-secondary);font-size:.82rem}
    .k-add{font-size:.82rem;color:var(--app-primary);cursor:pointer}
    .k-list{display:flex;flex-direction:column;gap:8px;padding:10px;min-height:80px}

    /* Compact cards: show ONLY title + project */
    .k-card{background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:12px;padding:10px;box-shadow:var(--shadow-xs);cursor:grab}
    .k-card:active{cursor:grabbing}
    .k-card .title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .k-card .meta{display:flex;gap:6px;margin-top:6px;color:var(--text-secondary);font-size:.78rem}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--border-light);border-radius:999px;white-space:nowrap}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .proj-kitchen{background:#1d73e8}.proj-bathroom{background:#ff9800}.proj-basement{background:#43a047}.proj-garden{background:#66bb6a}.proj-admin{background:#9c27b0}

    .k-placeholder{border:2px dashed var(--border-default);border-radius:12px;height:46px}

    /* Modal (detail panel) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .15s;z-index:1000}
    .modal-backdrop.show{opacity:1;pointer-events:auto}
    .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .15s;z-index:1001}
    .modal.open{opacity:1;pointer-events:auto}
    .modal-panel{width:min(960px,96vw);max-height:92vh;background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:16px;box-shadow:var(--shadow-lg);display:grid;grid-template-columns:1.2fr .8fr;overflow:hidden}
    .modal-header{grid-column:1/3;display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border-light)}
    .modal-body{display:grid;grid-template-columns:1fr;gap:14px;padding:16px;overflow:auto}
    .modal-aside{border-left:1px solid var(--border-light);padding:16px;overflow:auto}
    .modal-body input,.modal-body textarea,.modal-body select{width:100%;padding:9px;border:1px solid var(--border-default);background:var(--bg-secondary);color:var(--text-primary);border-radius:10px}
    .meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .aside-block{margin-bottom:14px}
    .aside-block h4{margin-bottom:8px}
    .modal-footer{grid-column:1/3;padding:12px 16px;border-top:1px solid var(--border-light);display:flex;gap:8px;justify-content:flex-end}
    .btn-primary{background:var(--app-primary);border-color:var(--app-primary);color:white}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-danger{border-color:#d32f2f;color:#d32f2f}
    .btn-danger:hover{background:#ffebee}
  </style>
</head>
<body class="app-page">
  <a href="#main" class="skip-to-main">Skip to main content</a>

  <!-- Global header -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>
      <button class="mobile-menu-toggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="mainNav" onclick="toggleMobileMenu()"><span aria-hidden="true">â˜°</span></button>
      <nav id="mainNav" class="main-nav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="kanban.html" class="active" aria-current="page">Kanban Board</a></li>
          <li><a href="budget.html">Budget Tracker</a></li>
          <li><a href="calendar.html">Calendar</a></li>
          <li><a href="documents.html">Documents</a></li>
        </ul>
      </nav>
      <div class="user-menu"><button class="user-avatar">AF</button></div>
    </div>
  </header>

  <main id="main" class="page-wrap">
    <section class="board-header">
      <div class="board-title">
        <h2>Kanban Board</h2>
        <div class="muted">Drag cards between columns. Click a card to see full details.</div>
      </div>
    </section>

    <!-- Toolbar: Search | Assignee | Project | +Task | Columns -->
    <div class="toolbar" role="region" aria-label="Board tools">
      <div class="search">
        <input id="searchInput" placeholder="Search by title, description, or tagsâ€¦" aria-label="Search tasks"/>
        <span class="icon" aria-hidden="true">ðŸ”Ž</span>
      </div>
      <div class="select">
        <select id="assigneeSelect" aria-label="Filter by assignee">
          <option value="">All assignees</option>
        </select>
      </div>
      <div class="select">
        <select id="projectSelect" aria-label="Filter by project">
          <option value="">All projects</option>
        </select>
      </div>
      <div class="actions">
        <button class="btn" id="addTaskBtn" aria-label="Add task">+ Task</button>
        <button class="btn" id="columnsBtn" aria-label="Configure columns">Columns</button>
      </div>
    </div>

    <!-- Board -->
    <section id="board" class="kanban" aria-label="Kanban board"></section>
  </main>

  <!-- Modal + Backdrop -->
  <div id="backdrop" class="modal-backdrop" aria-hidden="true"></div>
  <div id="modalRoot" class="modal" aria-hidden="true"></div>

  <!-- Toast -->
  <div id="toast" style="position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#111;color:#fff;padding:.55rem .8rem;border-radius:10px;box-shadow:0 8px 22px rgba(0,0,0,.28);opacity:0;pointer-events:none;z-index:1100;"></div>

  <script>
    /* Mobile nav */
    function toggleMobileMenu(){
      const nav = document.getElementById('mainNav');
      const btn = document.querySelector('.mobile-menu-toggle');
      const on = nav.classList.toggle('active');
      if(btn) btn.setAttribute('aria-expanded', on ? 'true' : 'false');
    }

    /* --------------------------
       Storage & Defaults
       -------------------------- */
    const STORAGE_KEY = 'atlas-kanban-v5'; // bump to avoid stale data
    const defaultState = {
      columns: [
        { id:'col-backlog',     name:'Backlog',      order:0 },
        { id:'col-inprogress',  name:'In Progress',  order:1 },
        { id:'col-blocked',     name:'Blocked',      order:2 },
        { id:'col-review',      name:'Review',       order:3 },
        { id:'col-done',        name:'Done',         order:4 },
      ],
      tasks: [
        { id:'t1', title:'Sketch permit set', desc:'Upload PDF to city portal.', project:'admin',    assignee:'Assignee A', due:'2025-10-18', column:'col-backlog',    tags:['permit'],     priority:'high',    createdAt: Date.now() },
        { id:'t2', title:'Order bathroom vanity', desc:'36\" oak, matte hardware.', project:'bathroom', assignee:'Assignee B', due:'2025-10-15', column:'col-backlog',    tags:['purchase'],   priority:'medium',  createdAt: Date.now() },
        { id:'t3', title:'Countertop template', desc:'Schedule template after cabinet alignment.', project:'kitchen',  assignee:'Assignee C', due:'2025-10-10', column:'col-review',     tags:['contractor'], priority:'low',     createdAt: Date.now() },
        { id:'t4', title:'Research countertop materials', desc:'Compare quartz vs. granite; shortlist local fabricators.', project:'kitchen',  assignee:'Assignee A', due:'2025-10-20', column:'col-inprogress', tags:['research'],   priority:'medium',  createdAt: Date.now() },
        { id:'t5', title:'Install backsplash', desc:'Herringbone layout; use leveling clips.', project:'kitchen',  assignee:'Assignee D', due:'2025-10-20', column:'col-blocked',    tags:['tile'],       priority:'high',    createdAt: Date.now() },
        { id:'t6', title:'Seal grout', desc:'After 72 hours, apply two coats.', project:'kitchen',  assignee:'Assignee A', due:'2025-10-22', column:'col-inprogress', tags:['finish'],     priority:'low',     createdAt: Date.now() },
        { id:'t7', title:'Greenhouse irrigation loop', desc:'Add timer and pressure regulator.', project:'garden',   assignee:'Assignee B', due:'2025-11-02', column:'col-backlog',    tags:['outdoor'],    priority:'medium',  createdAt: Date.now() },
        { id:'t8', title:'Close out punch list', desc:'Touch-up paint and hardware', project:'basement', assignee:'Assignee C', due:'2025-10-30', column:'col-done',       tags:['finish'],     priority:'low',     createdAt: Date.now() }
      ]
    };
    const state = loadState();

    function loadState(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        if(!parsed.columns || !parsed.tasks) return structuredClone(defaultState);
        return parsed;
      } catch(e){ return structuredClone(defaultState); }
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    /* --------------------------
       Rendering
       -------------------------- */
    const boardEl     = document.getElementById('board');
    const searchEl    = document.getElementById('searchInput');
    const assigneeEl  = document.getElementById('assigneeSelect');
    const projectEl   = document.getElementById('projectSelect');

    function projectDot(project){
      const map = { kitchen:'proj-kitchen', bathroom:'proj-bathroom', basement:'proj-basement', garden:'proj-garden', admin:'proj-admin' };
      const cls = map[project] || 'proj-admin';
      const label = project.charAt(0).toUpperCase()+project.slice(1);
      return `<span class="chip"><span class="dot ${cls}"></span>${label}</span>`;
    }

    function renderFilters(){
      const assignees = Array.from(new Set(state.tasks.map(t=>t.assignee))).filter(Boolean).sort();
      assigneeEl.innerHTML = `<option value="">All assignees</option>` + assignees.map(a=>`<option value="${a}">${a}</option>`).join('');

      const projects = Array.from(new Set(state.tasks.map(t=>t.project))).filter(Boolean).sort();
      projectEl.innerHTML = `<option value="">All projects</option>` + projects.map(p=>{
        const label = p.charAt(0).toUpperCase()+p.slice(1);
        return `<option value="${p}">${label}</option>`;
      }).join('');
    }

    function renderBoard(){
      const cols = [...state.columns].sort((a,b)=>a.order-b.order);
      const needle   = (searchEl.value||'').trim().toLowerCase();
      const assignee = assigneeEl.value;
      const project  = projectEl.value;

      boardEl.innerHTML = cols.map(col=>{
        const tasks = state.tasks.filter(t=>t.column===col.id).filter(t=>{
          const hit = (t.title+t.desc+(t.tags||[]).join(' ')).toLowerCase().includes(needle);
          const okAssignee = !assignee || t.assignee===assignee;
          const okProject  = !project  || t.project===project;
          return hit && okAssignee && okProject;
        });
        return `
          <article class="k-col" data-col-id="${col.id}" aria-labelledby="${col.id}-title">
            <header class="k-head">
              <div><span class="k-title" id="${col.id}-title">${col.name}</span> <span class="k-count">â€¢ ${tasks.length}</span></div>
              <button class="k-add btn" data-action="add-task" data-col="${col.id}">+ Task</button>
            </header>
            <div class="k-list" data-dropzone="${col.id}">
              ${tasks.map(renderCard).join('')}
            </div>
          </article>
        `;
      }).join('');

      // wire drag & drop and actions
      initDnD();
      boardEl.querySelectorAll('[data-action="add-task"]').forEach(btn=>{
        btn.addEventListener('click',()=>openTaskModal({ column: btn.dataset.col }));
      });
    }

    /* Compact card markup (title + project only) */
    function renderCard(t){
      return `
        <div class="k-card" draggable="true" data-task-id="${t.id}" aria-label="${t.title}" title="${escapeHTML(t.desc||'')}">
          <div class="title">${t.title}</div>
          <div class="meta">${projectDot(t.project)}</div>
        </div>
      `;
    }

    /* --------------------------
       Drag & Drop (no duplication)
       -------------------------- */
    function initDnD(){
      let draggingEl=null, placeholder=null;

      boardEl.querySelectorAll('.k-card').forEach(card=>{
        card.addEventListener('dragstart',e=>{
          draggingEl = card;
          e.dataTransfer.setData('text/plain', card.dataset.taskId);
          e.dataTransfer.effectAllowed='move';
          setTimeout(()=>card.style.opacity='.4');
        });
        card.addEventListener('dragend',()=>{
          if(draggingEl) draggingEl.style.opacity='';
          draggingEl=null;
          if(placeholder) placeholder.remove();
          placeholder=null;
        });
      });

      boardEl.querySelectorAll('.k-list').forEach(zone=>{
        zone.addEventListener('dragover',e=>{
          e.preventDefault();
          e.dataTransfer.dropEffect='move';
          if(!placeholder){ placeholder = document.createElement('div'); placeholder.className='k-placeholder'; }
          const after = getDragAfterElement(zone, e.clientY);
          if(after==null){ zone.appendChild(placeholder); } else { zone.insertBefore(placeholder, after); }
        });

        zone.addEventListener('drop',e=>{
          e.preventDefault();
          const id = e.dataTransfer.getData('text/plain');
          const srcIndex = state.tasks.findIndex(x=>x.id===id);
          if(srcIndex===-1) return;

          // Remove from array first to avoid duplicates
          const task = state.tasks.splice(srcIndex,1)[0];
          task.column = zone.dataset.dropzone;

          // Determine insertion index relative to "before" sibling in current array
          let beforeId = null;
          if(placeholder){
            const next = placeholder.nextElementSibling;
            beforeId = next && next.classList.contains('k-card') ? next.dataset.taskId : null;
            placeholder.remove(); placeholder=null;
          }
          if(beforeId){
            const idx = state.tasks.findIndex(t=>t.id===beforeId);
            if(idx>-1){ state.tasks.splice(idx,0,task); }
            else { state.tasks.push(task); }
          } else {
            state.tasks.push(task); // append to end of that column
          }

          saveState(); renderBoard(); toast('Task moved');
        });
      });

      function getDragAfterElement(container, y){
        const els = [...container.querySelectorAll('.k-card:not(.dragging)')];
        return els.reduce((closest, child)=>{
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height/2;
          if(offset<0 && offset>closest.offset){ return { offset, element: child }; }
          else { return closest; }
        }, {offset: Number.NEGATIVE_INFINITY}).element;
      }
    }

    /* --------------------------
       Modal helpers
       -------------------------- */
    const modalRoot = document.getElementById('modalRoot');
    const backdrop = document.getElementById('backdrop');

    function openModal(html){
      modalRoot.innerHTML = `<div class="modal-panel" role="dialog" aria-modal="true">${html}</div>`;
      modalRoot.classList.add('open');
      backdrop.classList.add('show');
      backdrop.onclick = closeModal;
      document.addEventListener('keydown', escClose);
    }
    function closeModal(){
      modalRoot.classList.remove('open');
      backdrop.classList.remove('show');
      modalRoot.innerHTML='';
      document.removeEventListener('keydown', escClose);
    }
    function escClose(e){ if(e.key==='Escape') closeModal(); }

    /* --------------------------
       Task modal (full detail view)
       -------------------------- */
    function openTaskModal(existing){
      const isEdit = existing && existing.id;
      const task = isEdit ? structuredClone(existing) : {
        id: 't'+crypto.randomUUID().slice(0,8),
        title:'', desc:'', project:'admin', assignee:'', due:'', column:(existing?.column || state.columns[0].id),
        tags:[], priority:'medium', createdAt: Date.now()
      };

      const colOpts = state.columns.sort((a,b)=>a.order-b.order).map(c=>`<option value="${c.id}" ${task.column===c.id?'selected':''}>${c.name}</option>`).join('');
      openModal(`
        <header class="modal-header">
          <h3>${isEdit?'Edit Task':'New Task'}</h3>
          <button class="btn" onclick="(${closeModal.toString()})()">âœ•</button>
        </header>

        <section class="modal-body">
          <div>
            <label>Title</label>
            <input id="fTitle" value="${escapeHTML(task.title)}" placeholder="What needs doing?"/>
          </div>

          <div>
            <label>Description</label>
            <textarea id="fDesc" rows="5" placeholder="Details, links, requirements...">${escapeHTML(task.desc)}</textarea>
          </div>

          <div class="meta-grid">
            <div>
              <label>Project</label>
              <select id="fProject">
                <option value="admin" ${task.project==='admin'?'selected':''}>Admin</option>
                <option value="kitchen" ${task.project==='kitchen'?'selected':''}>Kitchen</option>
                <option value="bathroom" ${task.project==='bathroom'?'selected':''}>Bathroom</option>
                <option value="basement" ${task.project==='basement'?'selected':''}>Basement</option>
                <option value="garden" ${task.project==='garden'?'selected':''}>Garden</option>
              </select>
            </div>
            <div>
              <label>Assignee (no personal names)</label>
              <input id="fAssignee" value="${escapeHTML(task.assignee)}" placeholder="e.g., Assignee A"/>
            </div>
            <div>
              <label>Due date</label>
              <input id="fDue" type="date" value="${task.due||''}"/>
            </div>
            <div>
              <label>Priority</label>
              <select id="fPriority">
                <option ${task.priority==='low'?'selected':''} value="low">Low</option>
                <option ${task.priority==='medium'?'selected':''} value="medium">Medium</option>
                <option ${task.priority==='high'?'selected':''} value="high">High</option>
              </select>
            </div>
            <div>
              <label>Column</label>
              <select id="fColumn">${colOpts}</select>
            </div>
            <div>
              <label>Tags (comma separated)</label>
              <input id="fTags" value="${escapeHTML((task.tags||[]).join(', '))}" placeholder="materials, vendor, paint"/>
            </div>
          </div>
        </section>

        <aside class="modal-aside">
          <div class="aside-block">
            <h4>Status</h4>
            <div>${state.columns.find(c=>c.id===task.column)?.name || ''}</div>
          </div>
          <div class="aside-block">
            <h4>Created</h4>
            <div>${new Date(task.createdAt||Date.now()).toLocaleString()}</div>
          </div>
          <div class="aside-block">
            <h4>Quick actions</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" onclick="document.getElementById('fColumn').value='col-inprogress'">Start</button>
              <button class="btn" onclick="document.getElementById('fColumn').value='col-review'">Send to Review</button>
              <button class="btn" onclick="document.getElementById('fColumn').value='col-done'">Mark Done</button>
            </div>
          </div>
        </aside>

        <footer class="modal-footer">
          ${isEdit?`<button class="btn btn-danger" id="deleteBtn">Delete</button>`:''}
          <button class="btn" onclick="(${closeModal.toString()})()">Cancel</button>
          <button class="btn btn-primary" id="saveBtn">${isEdit?'Save':'Create'}</button>
        </footer>
      `);

      document.getElementById('saveBtn').onclick = ()=>{
        const updated = {
          ...task,
          title: val('fTitle').trim(),
          project: val('fProject'),
          assignee: val('fAssignee').trim(),
          due: val('fDue'),
          priority: val('fPriority'),
          column: val('fColumn'),
          desc: val('fDesc').trim(),
          tags: val('fTags').split(',').map(s=>s.trim()).filter(Boolean)
        };
        if(!updated.title){ toast('Please add a title'); return; }
        if(isEdit){
          const idx = state.tasks.findIndex(x=>x.id===task.id);
          if(idx>-1) state.tasks[idx]=updated;
          toast('Task updated');
        } else {
          state.tasks.push(updated);
          toast('Task created');
        }
        saveState(); closeModal(); renderFilters(); renderBoard();
      };

      if(isEdit){
        document.getElementById('deleteBtn').onclick = ()=>{
          state.tasks = state.tasks.filter(x=>x.id!==task.id);
          saveState(); closeModal(); renderFilters(); renderBoard(); toast('Task deleted');
        };
      }
    }

    function val(id){ return document.getElementById(id).value; }
    function escapeHTML(s){ return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    /* --------------------------
       Columns dialog (insert smartly before Done)
       -------------------------- */
    function openColumnsDialog(){
      const rows = state.columns.sort((a,b)=>a.order-b.order).map(c=>`
        <tr data-id="${c.id}">
          <td><input value="${escapeHTML(c.name)}" data-field="name"/></td>
          <td style="width:154px;text-align:center;display:flex;gap:6px;justify-content:center">
            <button class="btn" data-move="up">â–²</button>
            <button class="btn" data-move="down">â–¼</button>
            <button class="btn" data-insert="after">+ Insert Below</button>
          </td>
          <td style="width:90px;text-align:center">
            <button class="btn btn-danger" data-remove="1">Remove</button>
          </td>
        </tr>`).join('');

      openModal(`
        <header class="modal-header">
          <h3>Configure Columns</h3>
          <button class="btn" onclick="(${closeModal.toString()})()">âœ•</button>
        </header>
        <div class="modal-body" style="grid-column:1/3">
          <table class="data-list" style="width:100%;border-collapse:separate;border-spacing:0 8px">
            <thead><tr><th>Name</th><th style="text-align:center">Order / Insert</th><th></th></tr></thead>
            <tbody id="colTbody">${rows}</tbody>
          </table>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="addColSmart">+ Add Column (before Done)</button>
          </div>
        </div>
        <footer class="modal-footer">
          <button class="btn" onclick="(${closeModal.toString()})()">Close</button>
          <button class="btn btn-primary" id="saveCols">Save</button>
        </footer>
      `);

      const tbody = document.getElementById('colTbody');
      tbody.addEventListener('click',e=>{
        const tr = e.target.closest('tr'); if(!tr) return;
        const id = tr.dataset.id;

        if(e.target.dataset.move==='up' || e.target.dataset.move==='down'){
          const dir = e.target.dataset.move==='up' ? -1 : 1;
          swapOrder(id, dir);
          saveState(); openColumnsDialog();
        }

        if(e.target.dataset.insert==='after'){
          const idx = state.columns.findIndex(c=>c.id===id);
          const newId='col-'+crypto.randomUUID().slice(0,6);
          const newCol = { id:newId, name:'New Column', order: state.columns[idx].order + 0.1 };
          state.columns.push(newCol);
          normalizeColumnOrder();
          saveState(); openColumnsDialog();
        }

        if(e.target.dataset.remove){
          if(state.tasks.some(t=>t.column===id)){ toast('Column not empty'); return; }
          state.columns = state.columns.filter(c=>c.id!==id);
          normalizeColumnOrder();
          saveState(); openColumnsDialog();
        }
      });

      document.getElementById('addColSmart').onclick = ()=>{
        const doneIdx = state.columns.findIndex(c=>c.id==='col-done' || /done/i.test(c.name));
        const insertOrder = doneIdx>-1 ? state.columns[doneIdx].order - 0.1 : (state.columns.at(-1)?.order ?? 0) + 1;
        const newId='col-'+crypto.randomUUID().slice(0,6);
        state.columns.push({ id:newId, name:'New Column', order: insertOrder });
        normalizeColumnOrder();
        saveState(); openColumnsDialog();
      };

      document.getElementById('saveCols').onclick = ()=>{
        [...tbody.querySelectorAll('tr')].forEach((tr)=>{
          const id=tr.dataset.id;
          const c = state.columns.find(x=>x.id===id);
          if(c){ c.name = tr.querySelector('[data-field="name"]').value.trim() || c.name; }
        });
        normalizeColumnOrder();
        saveState(); closeModal(); renderBoard(); toast('Columns saved');
      };
    }

    function swapOrder(id, dir){
      const cols = state.columns.sort((a,b)=>a.order-b.order);
      const idx = cols.findIndex(c=>c.id===id);
      const j = idx + dir;
      if(j<0 || j>=cols.length) return;
      const ai = cols[idx].order;
      cols[idx].order = cols[j].order;
      cols[j].order = ai;
      state.columns = cols;
      normalizeColumnOrder();
    }
    function normalizeColumnOrder(){
      state.columns.sort((a,b)=>a.order-b.order).forEach((c,i)=>c.order=i);
    }

    /* --------------------------
       Events & filters
       -------------------------- */
    document.getElementById('addTaskBtn').onclick = ()=>openTaskModal();
    document.getElementById('columnsBtn').onclick = openColumnsDialog;
    searchEl.addEventListener('input', renderBoard);
    assigneeEl.addEventListener('change', renderBoard);
    projectEl.addEventListener('change', renderBoard);

    boardEl.addEventListener('click',e=>{
      const card = e.target.closest('.k-card');
      if(!card) return;
      const t = state.tasks.find(x=>x.id===card.dataset.taskId);
      if(t) openTaskModal(t);
    });

    /* --------------------------
       Toast
       -------------------------- */
    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.opacity='1';
      setTimeout(()=>el.style.opacity='0', 1300);
    }

    /* --------------------------
       Boot
       -------------------------- */
    renderFilters();
    renderBoard();
  </script>
</body>
</html>
