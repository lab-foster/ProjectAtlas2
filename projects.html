<!-- File: projects.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <title>Projects - Project Atlas</title>

  <link rel="stylesheet" href="styles.css"/>
  <link rel="stylesheet" href="atlas-interactive.css"/>

  <style>
    /* ---------- Page polish ---------- */
    .projects-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-xl);padding-bottom:var(--space-md);border-bottom:1px solid var(--border-default);gap:var(--space-lg)}
    .project-filters{display:flex;gap:var(--space-md);flex-wrap:wrap;align-items:center;width:100%}
    .filter-select{padding:var(--space-sm) var(--space-md);border:1px solid var(--border-default);border-radius:var(--radius-md);background:var(--bg-secondary);color:var(--text-primary);font-size:.9375rem}
    .filter-select:focus{outline:0;border-color:var(--app-primary);box-shadow:0 0 0 3px var(--app-primary-light)}
    .filter-actions{margin-left:auto;display:flex;gap:var(--space-sm)}
    .filter-actions .btn{display:inline-flex;align-items:center;gap:.5rem}

    .projects-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--space-lg);margin-bottom:var(--space-xl)}
    .stat-card{background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:var(--space-lg);text-align:center;box-shadow:var(--shadow-sm)}
    .stat-number{font-size:2.2rem;font-weight:700;color:var(--app-primary);display:block}
    .stat-label{color:var(--text-secondary);font-size:.875rem;margin-top:.25rem}

    .projects-list{display:flex;flex-direction:column;gap:var(--space-xl)}
    .project-epic{background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:var(--radius-lg);padding:var(--space-xl);box-shadow:var(--shadow-sm)}
    .epic-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:var(--space-lg);gap:var(--space-md)}
    .epic-actions{display:flex;gap:var(--space-sm);margin-top:.25rem}
    .status-badge{font-size:.75rem;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--border-light);background:var(--bg-elevated)}
    .in-progress{color:#0b5bd3;border-color:#cfe0ff;background:#eef5ff}
    .planning{color:#8a6c00;border-color:#f7e3a0;background:#fff7d1}
    .blocked{color:#b00020;border-color:#ffd1d6;background:#fff1f3}
    .done{color:#2e7d32;border-color:#c8e6c9;background:#edf7ed}

    .epic-progress{background:var(--app-primary-lighter);padding:var(--space-lg);border-radius:var(--radius-md);border:1px solid var(--app-primary-light)}
    .progress-info{display:flex;justify-content:space-between;gap:var(--space-md);flex-wrap:wrap;color:var(--text-secondary);font-size:.875rem;margin-bottom:.5rem}
    .progress-bar{height:8px;background:#e6eefc;border-radius:8px;overflow:hidden}
    .progress-fill{height:100%;background:var(--app-primary)}

    .epic-tasks{display:flex;flex-direction:column;gap:.5rem;margin-top:var(--space-md)}
    .epic-tasks-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;padding-bottom:.5rem;border-bottom:1px solid var(--border-light)}
    .epic-tasks-header h4{margin:0;font-size:.95rem;color:var(--text-secondary);letter-spacing:.02em}
    .task-empty{font-size:.875rem;color:var(--text-tertiary);padding:.5rem 0}

    .task-item{display:flex;align-items:center;gap:.75rem;padding:.65rem .75rem;border-radius:10px;transition:background .12s,border-color .12s;cursor:pointer;border:1px solid transparent}
    .task-item:hover{background:var(--app-primary-lighter);border-color:var(--app-primary-light)}
    .task-checkbox{width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:6px;background:#f1f4f8;color:#667}
    .task-item.completed .task-checkbox{background:var(--status-success-bg);color:var(--status-success)}
    .task-item.active .task-checkbox{background:var(--status-info-bg);color:var(--status-info)}
    .task-item.blocked .task-checkbox{background:var(--status-error-bg);color:var(--status-error)}
    .task-name{flex:1;font-weight:600;color:var(--text-primary);font-size:.95rem}
    .task-status{font-size:.75rem;color:var(--text-tertiary);padding:.15rem .45rem;border:1px solid var(--border-light);border-radius:999px}

    /* ---------- Namespaced modal ---------- */
    .atlas-backdrop{position:fixed;inset:0;background:rgba(10,28,52,.35);opacity:0;pointer-events:none;transition:opacity .15s;z-index:1195}
    .atlas-backdrop.show{opacity:1;pointer-events:auto}
    .atlas-modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200}
    .atlas-modal-root.open{display:flex}
    .atlas-modal-panel{width:min(720px,92vw);background:var(--bg-secondary);border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;border:1px solid var(--border-default)}
    .atlas-modal-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border-light)}
    .atlas-modal-title{margin:0;font-size:1.15rem}
    .atlas-modal-body{padding:18px 20px;max-height:70vh;overflow:auto}
    .atlas-modal-footer{padding:14px 20px;border-top:1px solid var(--border-light);display:flex;justify-content:flex-end;gap:12px}
    .atlas-modal-close{border:none;background:transparent;font-size:1.5rem;cursor:pointer}
    .atlas-modal-open{overflow:hidden}

    .form-grid{display:grid;gap:12px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .input{width:100%;border:1px solid var(--border-default);border-radius:10px;padding:10px 12px;background:var(--bg-secondary)}
    .input:focus{outline:2px solid var(--app-primary-light);border-color:var(--app-primary)}

    /* --- Kill any legacy bottom drawers injected by other scripts --- */
    .task-details,.drawer.task-details,#taskDetails,.modal.task-details{display:none !important}

    @media (max-width:992px){.filter-actions{width:100%;justify-content:flex-end}}
    @media (max-width:768px){
      .projects-header{flex-direction:column;align-items:stretch}
      .projects-stats{grid-template-columns:repeat(2,1fr)}
      .progress-info{flex-direction:column;gap:.25rem}
      .epic-header{flex-direction:column;align-items:flex-start}
      .form-row{grid-template-columns:1fr}
    }
    @media (max-width:480px){.projects-stats{grid-template-columns:1fr}}
  </style>
</head>
<body class="app-page">
  <a href="#main-content" class="skip-to-main">Skip to main content</a>

  <!-- Header -->
  <header class="app-header">
    <div class="header-container">
      <div class="logo">
        <h1>Project <span class="atlas-blue">ATLAS</span></h1>
        <span class="tagline">Home Project Management</span>
      </div>

      <button class="mobile-menu-toggle"
              onclick="toggleMobileMenu()"
              aria-label="Toggle navigation menu"
              aria-expanded="false"
              aria-controls="mainNav">
        <span aria-hidden="true">☰</span>
      </button>

      <nav class="main-nav" id="mainNav" aria-label="Main navigation">
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="projects.html" class="active" aria-current="page">Projects</a></li>
          <li><a href="kanban.html">Kanban Board</a></li>
          <li><a href="budget.html">Budget Tracker</a></li>
          <li><a href="calendar.html">Calendar</a></li>
          <li><a href="documents.html">Documents</a></li>
        </ul>
      </nav>

      <div class="user-menu"><button class="user-avatar" aria-label="User menu">AF</button></div>
    </div>
  </header>

  <!-- Main -->
  <main class="dashboard-main" id="main-content">
    <div class="projects-header">
      <h2>Project Management</h2>
      <div class="project-filters" role="group" aria-label="Project filters">
        <label for="statusFilter" class="sr-only">Filter by status</label>
        <select class="filter-select" id="statusFilter">
          <option value="all">All Status</option>
          <option value="active">Active</option>
          <option value="planning">Planning</option>
          <option value="on-hold">On Hold</option>
          <option value="completed">Completed</option>
        </select>

        <label for="priorityFilter" class="sr-only">Filter by priority</label>
        <select class="filter-select" id="priorityFilter">
          <option value="all">All Priorities</option>
          <option value="high">High Priority</option>
          <option value="medium">Medium Priority</option>
          <option value="low">Low Priority</option>
        </select>

        <div class="filter-actions">
          <button class="btn btn-secondary" onclick="showNewProjectModal()">
            <span aria-hidden="true">＋</span> New Project
          </button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <section class="projects-stats" aria-label="Project statistics">
      <article class="stat-card"><span class="stat-number" id="statActive">3</span><span class="stat-label">Active Projects</span></article>
      <article class="stat-card"><span class="stat-number" id="statTasks">0</span><span class="stat-label">Total Tasks</span></article>
      <article class="stat-card"><span class="stat-number" id="statAvg">0%</span><span class="stat-label">Average Progress</span></article>
      <article class="stat-card"><span class="stat-number" id="statBudget">$75K</span><span class="stat-label">Total Budget</span></article>
    </section>

    <!-- Project epics -->
    <section class="projects-list" aria-label="Projects list" id="projectsList">
      <!-- Kitchen -->
      <article class="project-epic" data-project-id="kitchen" data-status="in-progress">
        <header class="epic-header">
          <div>
            <h3>Kitchen Renovation Epic</h3>
            <div class="epic-actions">
              <button class="btn-link" onclick="viewProject('kitchen')">View Board</button>
              <button class="btn-link" onclick="editProject('kitchen')">Edit</button>
              <button class="btn-link" onclick="openAddTaskModal('kitchen')">Add Task</button>
            </div>
          </div>
          <span class="status-badge in-progress">IN PROGRESS</span>
        </header>

        <div class="epic-progress">
          <div class="progress-info">
            <span><strong>Progress:</strong> 65%</span>
            <span><strong>Budget:</strong> $23,400 / $28,000</span>
            <span><strong>Timeline:</strong> Week 6 of 10</span>
          </div>
          <div class="progress-bar" role="progressbar" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100" aria-label="Project progress: 65%">
            <div class="progress-fill" style="width:65%"></div>
          </div>
        </div>

        <div class="epic-tasks">
          <div class="epic-tasks-header"><h4>Tasks</h4><span class="text-sm text-tertiary">Click to open details</span></div>

          <div class="task-item completed" data-task-id="t0" data-priority="low" role="button" tabindex="0"
               onclick="viewTask('t0')">
            <span class="task-checkbox" aria-hidden="true">✓</span>
            <span class="task-name">Demo existing kitchen</span>
            <span class="task-status">Completed</span>
          </div>

          <div class="task-item active" data-task-id="t4" data-priority="high" role="button" tabindex="0"
               onclick="viewTask('t4')">
            <span class="task-checkbox" aria-hidden="true">◐</span>
            <span class="task-name">Install backsplash</span>
            <span class="task-status">In Progress</span>
          </div>

          <div class="task-item pending" data-task-id="t6" data-priority="high" role="button" tabindex="0"
               onclick="viewTask('t6')">
            <span class="task-checkbox" aria-hidden="true">○</span>
            <span class="task-name">Countertop template</span>
            <span class="task-status">Done</span>
          </div>
        </div>
      </article>

      <!-- Basement -->
      <article class="project-epic" data-project-id="basement" data-status="planning">
        <header class="epic-header">
          <div>
            <h3>Basement Finishing Epic</h3>
            <div class="epic-actions">
              <button class="btn-link" onclick="viewProject('basement')">View Board</button>
              <button class="btn-link" onclick="editProject('basement')">Edit</button>
              <button class="btn-link" onclick="openAddTaskModal('basement')">Add Task</button>
            </div>
          </div>
          <span class="status-badge planning">PLANNING</span>
        </header>

        <div class="epic-progress">
          <div class="progress-info">
            <span><strong>Progress:</strong> 15%</span>
            <span><strong>Budget:</strong> $5,200 / $35,000</span>
            <span><strong>Timeline:</strong> Planning Phase</span>
          </div>
          <div class="progress-bar" role="progressbar" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100" aria-label="Project progress: 15%">
            <div class="progress-fill" style="width:15%"></div>
          </div>
        </div>

        <div class="epic-tasks">
          <div class="epic-tasks-header"><h4>Tasks</h4><span class="text-sm text-tertiary">Click to open details</span></div>

          <div class="task-item completed" data-task-id="t2" data-priority="high" role="button" tabindex="0"
               onclick="viewTask('t2')">
            <span class="task-checkbox" aria-hidden="true">✓</span>
            <span class="task-name">Submit basement permit</span>
            <span class="task-status">Planning</span>
          </div>

          <div class="task-item pending" data-task-id="tX1" data-priority="medium" role="button" tabindex="0"
               onclick="viewTask('tX1')">
            <span class="task-checkbox" aria-hidden="true">○</span>
            <span class="task-name">Get contractor quotes</span>
            <span class="task-status">Pending</span>
          </div>
        </div>
      </article>

      <!-- Bathroom -->
      <article class="project-epic" data-project-id="bathroom" data-status="blocked">
        <header class="epic-header">
          <div>
            <h3>Bathroom Update Epic</h3>
            <div class="epic-actions">
              <button class="btn-link" onclick="viewProject('bathroom')">View Board</button>
              <button class="btn-link" onclick="editProject('bathroom')">Edit</button>
              <button class="btn-link" onclick="openAddTaskModal('bathroom')">Add Task</button>
            </div>
          </div>
          <span class="status-badge blocked">BLOCKED</span>
        </header>

        <div class="epic-progress">
          <div class="progress-info">
            <span><strong>Progress:</strong> 40%</span>
            <span><strong>Budget:</strong> $8,100 / $12,000</span>
            <span><strong>Blocked:</strong> Inspection pending</span>
          </div>
          <div class="progress-bar" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" aria-label="Project progress: 40%">
            <div class="progress-fill" style="width:40%"></div>
          </div>
        </div>

        <div class="epic-tasks">
          <div class="epic-tasks-header"><h4>Tasks</h4><span class="text-sm text-tertiary">Click to open details</span></div>

          <div class="task-item blocked" data-task-id="t9" data-priority="high" role="button" tabindex="0"
               onclick="viewTask('t9')">
            <span class="task-checkbox" aria-hidden="true">⚠</span>
            <span class="task-name">Schedule plumbing inspection</span>
            <span class="task-status">Blocked</span>
          </div>

          <div class="task-item pending" data-task-id="t3" data-priority="medium" role="button" tabindex="0"
               onclick="viewTask('t3')">
            <span class="task-checkbox" aria-hidden="true">○</span>
            <span class="task-name">Order bathroom vanity</span>
            <span class="task-status">Ready</span>
          </div>
        </div>
      </article>
    </section>
  </main>

  <!-- Namespaced modal root -->
  <div id="atlasBackdrop" class="atlas-backdrop"></div>
  <div id="atlasModalRoot" class="atlas-modal-root" aria-hidden="true"></div>

  <script>
    /* ---------- Nav ---------- */
    function toggleMobileMenu(){
      const nav=document.getElementById('mainNav');
      const toggle=document.querySelector('.mobile-menu-toggle');
      const isExpanded=nav.classList.toggle('active');
      toggle.setAttribute('aria-expanded',isExpanded);
    }

    /* ---------- Utilities ---------- */
    function slugify(s){return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');}
    function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));}
    function toast(msg){
      let el=document.getElementById('atlas-toast');
      if(!el){
        el=document.createElement('div');
        el.id='atlas-toast';
        el.style.cssText='position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0b3a75;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 18px rgba(0,0,0,.2);z-index:1300;opacity:0;transition:opacity .15s';
        document.body.appendChild(el);
      }
      el.textContent=msg; el.style.opacity='1'; setTimeout(()=>el.style.opacity='0',1400);
    }

    /* ---------- Storage ---------- */
    const ProjectStore={ key:'atlas.projects',
      read(){try{return JSON.parse(localStorage.getItem(this.key))||[];}catch{return[]}},
      write(v){localStorage.setItem(this.key,JSON.stringify(v));}
    };
    const KanbanStore={ key:'atlas.kanban.tasks',
      read(){try{return JSON.parse(localStorage.getItem(this.key))||[];}catch{return[]}},
      write(v){localStorage.setItem(this.key,JSON.stringify(v));},
      ensureSeed(){
        const list=this.read(); if(list.length) return;
        this.write([
          {id:"t1", title:"Research countertop materials", desc:"Quartz vs granite. Check local fabricators.", status:"Someday", project:"kitchen", assignee:"Assignee A", priority:"Low", due:""},
          {id:"t2", title:"Submit basement permit", desc:"City of Woodinville online portal", status:"Someday", project:"basement", assignee:"Assignee A", priority:"High", due:"2025-10-18"},
          {id:"t3", title:"Order bathroom vanity", desc:"36” oak, matte hardware", status:"Ready", project:"bathroom", assignee:"Assignee B", priority:"Medium", due:"2025-10-15"},
          {id:"t4", title:"Install backsplash", desc:"Herringbone layout; use leveling clips.", status:"In Progress", project:"kitchen", assignee:"Assignee D", priority:"High", due:"2025-10-20"},
          {id:"t5", title:"Seal grout", desc:"After 72 hours, two coats.", status:"Blocked", project:"kitchen", assignee:"Assignee A", priority:"Low", due:""},
          {id:"t6", title:"Countertop template", desc:"Schedule after cabinet alignment.", status:"Done", project:"kitchen", assignee:"Assignee C", priority:"High", due:"2025-10-10"},
          {id:"t9", title:"Schedule plumbing inspection", desc:"Book with city inspector", status:"Blocked", project:"bathroom", assignee:"Assignee A", priority:"High", due:"2025-10-13"}
        ]);
      }
    };
    KanbanStore.ensureSeed();

    /* ---------- Namespaced modal ---------- */
    function openModal(title,bodyHtml,footerHtml){
      const backdrop=document.getElementById('atlasBackdrop');
      const root=document.getElementById('atlasModalRoot');
      root.innerHTML=`
        <div class="atlas-modal-panel" role="dialog" aria-modal="true" aria-label="${escapeHtml(title)}">
          <div class="atlas-modal-header">
            <h3 class="atlas-modal-title">${escapeHtml(title)}</h3>
            <button class="atlas-modal-close" aria-label="Close" onclick="closeModal()">&times;</button>
          </div>
          <div class="atlas-modal-body">${bodyHtml}</div>
          <div class="atlas-modal-footer">${footerHtml||'<button class="btn" onclick="closeModal()">Close</button>'}</div>
        </div>`;
      backdrop.classList.add('show');
      root.classList.add('open');
      root.setAttribute('aria-hidden','false');
      document.body.classList.add('atlas-modal-open');
      setTimeout(()=>{const f=root.querySelector('input,select,textarea,button'); if(f) f.focus();},0);
    }
    function closeModal(){
      document.getElementById('atlasBackdrop').classList.remove('show');
      const root=document.getElementById('atlasModalRoot');
      root.classList.remove('open'); root.setAttribute('aria-hidden','true'); root.innerHTML='';
      document.body.classList.remove('atlas-modal-open');
    }
    document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

    /* ---------- Create/Edit Projects ---------- */
    function showNewProjectModal(){ /* … unchanged … */ openModal('Create New Project', `
      <div class="form-grid">
        <label for="p_name">Project Name *</label>
        <input id="p_name" class="input" placeholder="e.g., Kitchen Renovation Epic"/>
        <div class="form-row">
          <div><label for="p_budget">Budget (USD)</label><input id="p_budget" type="number" class="input" placeholder="e.g., 28000"/></div>
          <div><label for="p_status">Initial Status</label>
            <select id="p_status" class="input"><option>Someday</option><option>Planning</option><option selected>Ready</option><option>In Progress</option><option>Blocked</option><option>Done</option></select>
          </div>
        </div>
        <div class="form-row">
          <div><label for="p_seed">Seed a starter task?</label><select id="p_seed" class="input"><option value="yes" selected>Yes</option><option value="no">No</option></select></div>
          <div><label for="p_assignee">Default Assignee</label><select id="p_assignee" class="input"><option>Assignee A</option><option>Assignee B</option><option>Contractor</option></select></div>
        </div>
      </div>`,
      `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn" onclick="createProject()">Create Project</button>`);}
    function createProject(){ const name=document.getElementById('p_name').value.trim(); const budget=document.getElementById('p_budget').value.trim(); const status=document.getElementById('p_status').value; const seed=document.getElementById('p_seed').value==='yes'; const assignee=document.getElementById('p_assignee').value; if(!name){ toast('Project name is required.'); return; } const id=slugify(name); const projects=ProjectStore.read(); if(projects.some(p=>p.id===id)){ toast('A project with that name already exists.'); return; } projects.push({id,name,budget:budget?Number(budget):null,createdAt:Date.now()}); ProjectStore.write(projects); if(seed){ const tasks=KanbanStore.read(); tasks.push({id:'t'+Math.random().toString(36).slice(2,7), title:'Kickoff: outline scope', desc:'Define goals, rough budget, and timeline.', status, project:id, assignee, priority:'Medium', due:''}); KanbanStore.write(tasks);} closeModal(); toast('Project created.'); viewProject(id); }
    function editProject(projectId){ const projects=ProjectStore.read(); const p=projects.find(x=>x.id===projectId); if(!p){ toast('Project not found.'); return; } openModal('Edit Project', `
      <div class="form-grid">
        <label>Name</label><input id="ep_name" class="input" value="${escapeHtml(p.name)}"/>
        <div class="form-row">
          <div><label>Budget (USD)</label><input id="ep_budget" type="number" class="input" value="${p.budget??''}"/></div>
          <div><label>Project ID (read-only)</label><input class="input" value="${escapeHtml(p.id)}" readonly/></div>
        </div>
      </div>`,
      `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn" onclick="saveProject('${p.id}')">Save</button>`);}
    function saveProject(id){ const projects=ProjectStore.read(); const i=projects.findIndex(x=>x.id===id); if(i<0){ toast('Project not found.'); return; } projects[i].name=document.getElementById('ep_name').value.trim()||projects[i].name; const b=document.getElementById('ep_budget').value.trim(); projects[i].budget=b?Number(b):null; ProjectStore.write(projects); toast('Project updated.'); closeModal(); }

    /* ---------- Tasks ---------- */
    function openAddTaskModal(projectId){ openModal('Add Task', `
      <label for="at_title">Title *</label><input id="at_title" class="input" placeholder="e.g., Schedule inspection"/>
      <label for="at_desc">Description</label><textarea id="at_desc" class="input" rows="3"></textarea>
      <div class="form-row"><div><label for="at_status">Status</label><select id="at_status" class="input">${['Someday','Planning','Ready','In Progress','Blocked','Done'].map(s=>`<option>${s}</option>`).join('')}</select></div>
      <div><label for="at_assignee">Assignee</label><select id="at_assignee" class="input"><option>Assignee A</option><option>Assignee B</option><option>Contractor</option></select></div></div>
      <div class="form-row"><div><label for="at_priority">Priority</label><select id="at_priority" class="input"><option>Low</option><option selected>Medium</option><option>High</option></select></div>
      <div><label for="at_due">Due</label><input id="at_due" type="date" class="input"/></div></div>`,
      `<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn" onclick="createTask('${projectId}')">Create Task</button>`);}
    function createTask(projectId){ const title=document.getElementById('at_title').value.trim(); if(!title){ toast('Title is required.'); return; } const desc=document.getElementById('at_desc').value.trim(); const status=document.getElementById('at_status').value; const assignee=document.getElementById('at_assignee').value; const priority=document.getElementById('at_priority').value; const due=document.getElementById('at_due').value; const tasks=KanbanStore.read(); tasks.push({id:'t'+Math.random().toString(36).slice(2,7), title, desc, status, assignee, priority, due, project:projectId}); KanbanStore.write(tasks); closeModal(); toast('Task created.'); applyFilters(); }

    function viewTask(taskId){
      const tasks=KanbanStore.read();
      let t=tasks.find(x=>x.id===taskId);
      if(!t){
        const el=document.querySelector(`[data-task-id="${taskId}"] .task-name`);
        const parent=el?.closest('.project-epic');
        const pid=parent?.getAttribute('data-project-id')||'general';
        t={id:taskId,title:(el?.textContent||'Untitled Task').trim(),desc:'',status:'Planning',project:pid,assignee:'Assignee A',priority:'Medium',due:''};
        tasks.push(t); KanbanStore.write(tasks);
      }
      openModal('Task Details', `
        <label>Title</label><input id="td_title" class="input" value="${escapeHtml(t.title)}"/>
        <label>Description</label><textarea id="td_desc" class="input" rows="4">${escapeHtml(t.desc)}</textarea>
        <div class="form-row"><div><label>Status</label><select id="td_status" class="input">${['Someday','Planning','Ready','In Progress','Blocked','Done'].map(s=>`<option ${t.status===s?'selected':''}>${s}</option>`).join('')}</select></div>
        <div><label>Assignee</label><select id="td_assignee" class="input">${['Assignee A','Assignee B','Contractor'].map(a=>`<option ${t.assignee===a?'selected':''}>${a}</option>`).join('')}</select></div></div>
        <div class="form-row"><div><label>Priority</label><select id="td_priority" class="input">${['Low','Medium','High'].map(p=>`<option ${t.priority===p?'selected':''}>${p}</option>`).join('')}</select></div>
        <div><label>Due</label><input id="td_due" type="date" class="input" value="${escapeHtml(t.due)}"/></div></div>`,
        `<button class="btn btn-secondary" onclick="closeModal()">Close</button><button class="btn btn-secondary" onclick="openOnBoard('${t.project||'general'}')">Open on Board</button><button class="btn" onclick="saveTask('${t.id}')">Save Changes</button>`
      );
    }
    function saveTask(id){ const tasks=KanbanStore.read(); const i=tasks.findIndex(x=>x.id===id); if(i===-1){ toast('Task not found.'); return; } tasks[i].title=document.getElementById('td_title').value.trim()||tasks[i].title; tasks[i].desc=document.getElementById('td_desc').value.trim(); tasks[i].status=document.getElementById('td_status').value; tasks[i].assignee=document.getElementById('td_assignee').value; tasks[i].priority=document.getElementById('td_priority').value; tasks[i].due=document.getElementById('td_due').value; KanbanStore.write(tasks); toast('Task updated.'); closeModal(); applyFilters(); }

    /* ---------- Filters & Nav helpers ---------- */
    function viewProject(id){ window.location.href=`kanban.html?project=${id}`; }
    function openOnBoard(projectId){ closeModal(); viewProject(projectId); }

    function mapStatus(val){ const m={ 'active':'in-progress', 'planning':'planning', 'on-hold':'blocked', 'completed':'done' }; return m[val]||null; }
    function applyFilters(){
      const statusVal=document.getElementById('statusFilter').value;   // all | active | planning | on-hold | completed
      const prioVal=document.getElementById('priorityFilter').value;   // all | high | medium | low
      const wantedStatus = mapStatus(statusVal);
      const tasks = KanbanStore.read();

      document.querySelectorAll('.project-epic').forEach(epic=>{
        const projectStatus = epic.getAttribute('data-status');
        const statusPass = !wantedStatus || projectStatus===wantedStatus;

        let anyVisible = false;
        epic.querySelectorAll('.task-item').forEach(tEl=>{
          if(prioVal==='all'){ tEl.style.display='flex'; anyVisible=true; return; }
          let p = (tEl.getAttribute('data-priority')||'').toLowerCase();
          if(!p){ const t = tasks.find(x=>x.id===tEl.getAttribute('data-task-id')); p=(t?.priority||'').toLowerCase(); }
          const ok = p===prioVal;
          tEl.style.display = ok ? 'flex' : 'none';
          if(ok) anyVisible = true;
        });

        let empty = epic.querySelector('.task-empty');
        if(!anyVisible && prioVal!=='all'){
          if(!empty){ empty=document.createElement('div'); empty.className='task-empty'; empty.textContent='No tasks match current filters.'; epic.querySelector('.epic-tasks').appendChild(empty); }
        } else if(empty){ empty.remove(); }

        epic.style.display = (statusPass && (anyVisible || prioVal==='all')) ? '' : 'none';
      });
    }
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('priorityFilter').addEventListener('change', applyFilters);

    (function hydrateStats(){
      const tasks=KanbanStore.read();
      const totalTasks=tasks.length, done=tasks.filter(t=>t.status==='Done').length;
      document.getElementById('statTasks').textContent=totalTasks.toString();
      document.getElementById('statAvg').textContent=(totalTasks?Math.round(done/totalTasks*100):0)+'%';
      const projects=ProjectStore.read();
      document.getElementById('statActive').textContent=(projects?.length||3).toString();
    })();

    /* ---------- Legacy drawer sweeper ---------- */
    const legacySelectors = ['#taskDetails','.task-details','.drawer.task-details','.modal.task-details'];
    function removeLegacyNow(){ legacySelectors.forEach(sel=>document.querySelectorAll(sel).forEach(el=>el.remove())); }
    document.addEventListener('DOMContentLoaded', ()=>{ removeLegacyNow(); applyFilters(); });
    const mo = new MutationObserver(()=>removeLegacyNow());
    mo.observe(document.body, {childList:true,subtree:true});
  </script>

  <!-- ===== CRITICAL GUARD =====
       Stop atlas-interactive's universal task handler from opening its own modal.
       We capture earlier, open our modal, then stop propagation. -->
  <script>
    document.addEventListener('click', function(e){
      const target = e.target.closest('[data-task-id], .task-link');
      if(!target) return;
      const id = target.getAttribute('data-task-id') || (target.getAttribute('href')||'').replace('#','');
      if(!id) return;
      // Use our modal:
      if(typeof window.viewTask === 'function'){ e.preventDefault(); window.viewTask(id); }
      // Block anyone else (including capture listeners registered later):
      e.stopImmediatePropagation();
      e.stopPropagation();
    }, true); // capture
  </script>

  <!-- Keep the main site script last -->
  <script src="atlas-interactive.js"></script>
</body>
</html>
